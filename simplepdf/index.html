<!DOCTYPE html>
<html data-content_root="./" lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   CMSIS-RTOS V2 Ejemplos 1.0 documentation
  </title>
  <link href="_static/pygments.css?v=649a27d8" rel="stylesheet" type="text/css"/>
  <link href="_static/main.css?v=b5a0f0f0" rel="stylesheet" type="text/css"/>
  <script src="_static/documentation_options.js?v=b5f0cf65">
  </script>
  <script src="_static/doctools.js?v=9bcbadda">
  </script>
  <script src="_static/sphinx_highlight.js?v=dc90522c">
  </script>
  <link href="genindex.html" rel="index" title="Index"/>
  <link href="search.html" rel="search" title="Search"/>
 </head>
 <body>
  <article class="dont-break" id="cover">
   <div class="container">
    <!-- Logo -->
    <div class="logo">
     <p>
     </p>
    </div>
    <!-- Cover middle -->
    <div class="cover-middle">
     <div class="title">
      <h1 class="title-cover">
       CMSIS-RTOS V2 Ejemplos
      </h1>
      <p class="subtitle-cover">
       Version 1.0
      </p>
      <span class="meta">
      </span>
     </div>
     <!--
      <div class="client-logo">
        <img src="../data/logo_.png" alt="Logotipo">
      </div>
      -->
    </div>
    <!-- Footer -->
    <div class="cover-footer">
     <p>
     </p>
    </div>
   </div>
  </article>
  <div aria-label="Main" class="sphinxsidebar" role="navigation">
   <div class="sphinxsidebarwrapper">
    <div>
     <h3>
      <a href="#">
       Table of Contents
      </a>
     </h3>
     <ul>
      <li class="toctree-l1">
       <a class="reference internal" href="#ejemplos-basicos-cmsis-rtos-v2">
        1. Ejemplos b&aacute;sicos CMSIS RTOS V2
       </a>
       <ul>
        <li class="toctree-l2">
         <a class="reference internal" href="#documentacion-en-otros-idiomas">
          1.1. Documentaci&oacute;n en otros idiomas
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#descarga-del-codigo">
          1.2. Descarga del c&oacute;digo
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#listado-de-ejemplos-incluidos">
          1.3. Listado de ejemplos incluidos
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#configuracion-del-proyecto-de-keil">
          1.4. Configuraci&oacute;n del Proyecto de Keil
         </a>
         <ul>
          <li class="toctree-l3">
           <a class="reference internal" href="#uso-del-simulador">
            1.4.1. Uso del simulador
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#uso-del-hardware">
            1.4.2. Uso del hardware
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#depuracion-de-aplicaciones-usando-cmsis-rtos-v2">
            1.4.3. Depuraci&oacute;n de aplicaciones usando CMSIS-RTOS V2
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#symbols-window">
            1.4.4. Symbols Window
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#logic-analyzer">
            1.4.5. Logic Analyzer
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#performance-analyzer">
            1.4.6. Performance Analyzer
           </a>
          </li>
         </ul>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#codigo-en-main-c-de-los-ejemplos">
          1.5. C&oacute;digo en main.c de los ejemplos
         </a>
         <ul>
          <li class="toctree-l3">
           <a class="reference internal" href="#algunos-detalles-importantes">
            1.5.1. Algunos detalles importantes
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="#uso-basico-de-un-thread-en-cmsis-rtos-v2">
        2. Uso b&aacute;sico de un thread en CMSIS RTOS v2
       </a>
       <ul>
        <li class="toctree-l2">
         <a class="reference internal" href="#descripcion-general-de-ejemplothread">
          2.1. Descripci&oacute;n General de ejemplothread
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#estructura-de-datos">
          2.2. Estructura de Datos
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#inicializacion-de-los-hilos">
          2.3. Inicializaci&oacute;n de los hilos
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#funcion-del-hilo">
          2.4. Funci&oacute;n del hilo
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#uso-de-hal-y-cmsis-rtos">
          2.5. Uso de HAL y CMSIS RTOS
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#codigo-fuente">
          2.6. C&oacute;digo Fuente
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#dependencias">
          2.7. Dependencias
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#preguntas-y-respuestas-sobre-ejemplothread">
          2.8. Preguntas y respuestas sobre ejemplothread
         </a>
         <ul>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-hace-este-codigo">
            2.8.1. &iquest;Qu&eacute; hace este c&oacute;digo?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-es-la-estructura-mygpio-pin">
            2.8.2. &iquest;Qu&eacute; es la estructura
            <cite>
             mygpio_pin
            </cite>
            ?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#como-se-inicializa-el-hilo">
            2.8.3. &iquest;C&oacute;mo se inicializa el hilo?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-hace-la-funcion-thread">
            2.8.4. &iquest;Qu&eacute; hace la funci&oacute;n
            <cite>
             Thread()
            </cite>
            ?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-significa-osdelay">
            2.8.5. &iquest;Qu&eacute; significa
            <cite>
             osDelay()
            </cite>
            ?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-pasa-si-osthreadnew-devuelve-null">
            2.8.6. &iquest;Qu&eacute; pasa si
            <cite>
             osThreadNew()
            </cite>
            devuelve NULL?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-ficheros-de-cabecera-se-utilizan">
            2.8.7. &iquest;Qu&eacute; ficheros de cabecera se utilizan?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#determine-la-carga-de-la-cpu-en-esta-aplicacion">
            2.8.8. Determine la carga de la CPU en esta aplicaci&oacute;n
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="#uso-basico-de-threads-en-cmsis-rtos-v2">
        3. Uso b&aacute;sico de threads en CMSIS RTOS v2
       </a>
       <ul>
        <li class="toctree-l2">
         <a class="reference internal" href="#descripcion-general">
          3.1. Descripci&oacute;n General
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#estructura-mygpio-pin">
          3.2. Estructura mygpio_pin
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#inicializacion-de-los-threads">
          3.3. Inicializaci&oacute;n de los threads
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#thread">
          3.4.
          <code class="docutils literal notranslate">
           <span class="pre">
            Thread()
           </span>
          </code>
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#hal-y-cmsis-rtos">
          3.5. HAL y CMSIS RTOS
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#codigo">
          3.6. C&oacute;digo
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#dependencias-software">
          3.7. Dependencias software
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#preguntas-y-respuestas-sobre-ejemplothreads">
          3.8. Preguntas y respuestas sobre ejemplothreads
         </a>
         <ul>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-funcion-hace-este-codigo">
            3.8.1. &iquest;Qu&eacute; funci&oacute;n hace este c&oacute;digo?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-funcion-tiene-mygpio-pin">
            3.8.2. &iquest;Qu&eacute;  funci&oacute;n tiene
            <cite>
             mygpio_pin
            </cite>
            ?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#como-se-inicializan-los-hilos">
            3.8.3. &iquest;C&oacute;mo se inicializan los hilos?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-funcion-tieneo-thread">
            3.8.4. &iquest;Qu&eacute; funci&oacute;n tiene&ordm;
            <cite>
             Thread()
            </cite>
            ?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#se-ejecutan-los-hilos-al-mismo-tiempo">
            3.8.5. &iquest;Se ejecutan los hilos al mismo tiempo?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-funcion-tiene-osdelay">
            3.8.6. &iquest;Qu&eacute; funci&oacute;n tiene
            <code class="docutils literal notranslate">
             <span class="pre">
              osDelay()
             </span>
            </code>
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-pasa-si-osthreadnew-retorna-null">
            3.8.7. &iquest;Qu&eacute; pasa si
            <cite>
             osThreadNew()
            </cite>
            retorna NULL?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-includes-se-utilizan">
            3.8.8. &iquest;Qu&eacute; includes se utilizan?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#cuanto-vale-el-valor-del-tick-es-esta-aplicacion">
            3.8.9. &iquest;Cuanto vale el valor del tick es esta aplicaci&oacute;n?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-es-el-thread-idle-que-tamano-de-stack-tiene-y-otro-thread-que-tamano-de-stack-usa">
            3.8.10. &iquest;Que es el thread Idle? &iquest;Qu&eacute; tama&ntilde;o de stack tiene? &iquest;Y otro thread? &iquest;Que tama&ntilde;o de stack usa?
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="#uso-basico-de-threads-y-colas-en-cmsis-rtos-v2">
        4. Uso b&aacute;sico de threads y colas en CMSIS RTOS v2
       </a>
       <ul>
        <li class="toctree-l2">
         <a class="reference internal" href="#descripcion-general">
          4.1. Descripci&oacute;n General
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#estructuras-de-datos">
          4.2. Estructuras de Datos
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#creacion-hilos">
          4.3. Creaci&oacute;n Hilos
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#producer">
          4.4. Producer
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#consumer">
          4.5. Consumer
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#hal-cmsis-rtos">
          4.6. HAL-CMSIS RTOS
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#fuente">
          4.7. Fuente
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#dependencias-de-software">
          4.8. Dependencias de software
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#preguntas-y-respuestas-sobre-ejemplothreads-queues">
          4.9. Preguntas y respuestas sobre ejemplothreads-queues
         </a>
         <ul>
          <li class="toctree-l3">
           <a class="reference internal" href="#cual-es-el-proposito-de-la-cola-de-mensajes-id-msgqueue-en-esta-aplicacion">
            4.9.1. &iquest;Cu&aacute;l es el prop&oacute;sito de la cola de mensajes
            <cite>
             id_MsgQueue
            </cite>
            en esta aplicaci&oacute;n?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#que-funcion-cumple-el-bucle-anidado-en-el-hilo-producer">
            4.9.2. &iquest;Qu&eacute; funci&oacute;n cumple el bucle anidado en el hilo
            <cite>
             Producer
            </cite>
            ?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#cuanto-tiempo-tarda-en-llenarse-la-cola-de-mensajes-id-msgqueue">
            4.9.3. &iquest;Cuanto tiempo tarda en llenarse la cola de mensajes
            <cite>
             id_MsgQueue
            </cite>
            ?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#cuanto-vale-la-variable-errors-or-timeouts-despues-de-1-minuto-de-ejecucion-del-codigo">
            4.9.4. &iquest;cuanto vale la variable errors_or_timeouts despues de 1 minuto de ejecuci&oacute;n del c&oacute;digo?
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="#uso-basico-de-threads-y-flags-en-cmsis-rtos-v2">
        5. Uso b&aacute;sico de threads y flags en CMSIS RTOS v2
       </a>
       <ul>
        <li class="toctree-l2">
         <a class="reference internal" href="#descripcion">
          5.1. Descripci&oacute;n
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#funcion-del-hilo-producer">
          5.2. Funci&oacute;n del hilo Producer
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#funcion-del-hilo-consumer">
          5.3. Funci&oacute;n del hilo Consumer
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#hal-y-cmsis-rtos">
          5.4. HAL y CMSIS RTOS
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#codigo-aplicacion">
          5.5. C&oacute;digo aplicaci&oacute;n
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#dependencias-de-software-del-ejemplo">
          5.6. Dependencias de software del ejemplo
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#preguntas-y-respuestas-sobre-ejemplothreads-flags">
          5.7. Preguntas y respuestas sobre ejemplothreads-flags
         </a>
         <ul>
          <li class="toctree-l3">
           <a class="reference internal" href="#se-modifica-el-codigo-del-producer-para-que-envie-ambas-senales-0x0001-y-0x0002-de-forma-casi-simultanea-seguido-de-un-delay-de-1-segundo">
            5.7.1. Se modifica el c&oacute;digo del Producer para que env&iacute;e ambas se&ntilde;ales (0x0001 y 0x0002) de forma casi simult&aacute;nea, seguido de un delay de 1 segundo:
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="#uso-basico-de-threads-y-software-timers-en-cmsis-rtos-v2">
        6. Uso b&aacute;sico de threads y software timers en CMSIS RTOS v2
       </a>
       <ul>
        <li class="toctree-l2">
         <a class="reference internal" href="#descripcion-general">
          6.1. Descripci&oacute;n General
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#funcion-del-hilo-timers">
          6.2. Funci&oacute;n del Hilo
          <code class="docutils literal notranslate">
           <span class="pre">
            Timers
           </span>
          </code>
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#uso-de-hal-y-cmsis-rtos">
          6.3. Uso de HAL y CMSIS RTOS
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#codigo-especifico">
          6.4. C&oacute;digo espec&iacute;fico
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#dependencia">
          6.5. Dependencia
         </a>
        </li>
        <li class="toctree-l2">
         <a class="reference internal" href="#preguntas-y-respuestas-sobre-ejemplothreads-timers">
          6.6. Preguntas y respuestas sobre ejemplothreads-timers
         </a>
         <ul>
          <li class="toctree-l3">
           <a class="reference internal" href="#cual-es-la-diferencia-fundamental-entre-un-timer-periodico-otro-one-shot">
            6.6.1. &iquest;Cual es la diferencia fundamental entre un timer peri&oacute;dico otro one-shot?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#los-ficheros-rtx-config-h-y-rtx-config-c-son-generados-automaticamente-por-el-entorno-de-desarrollo-se-pueden-modificar">
            6.6.2. Los ficheros RTX_config.h y RTX_config.c son generados autom&aacute;ticamente por el entorno de desarrollo. &iquest;Se pueden modificar?
           </a>
          </li>
          <li class="toctree-l3">
           <a class="reference internal" href="#si-se-fija-un-punto-de-ruptura-en-la-linea-47-que-se-espera-ver-en-el-watch-windows-rtx-rtos">
            6.6.3. Si se fija un punto de ruptura en la l&iacute;nea 47, &iquest;qu&eacute; se espera ver en el
            <code class="docutils literal notranslate">
             <span class="pre">
              Watch
             </span>
             <span class="pre">
              Windows-&gt;RTX
             </span>
             <span class="pre">
              RTOS
             </span>
            </code>
            ?
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
   </div>
  </div>
  <div class="document">
   <div class="documentwrapper">
    <div class="bodywrapper">
     <div class="body" role="main">
      <div class="toctree-wrapper compound">
       <span id="document-cmsis-rtos">
       </span>
       <section id="ejemplos-basicos-cmsis-rtos-v2">
        <span id="cmsis-rtos">
        </span>
        <h1>
         Ejemplos b&aacute;sicos CMSIS RTOS V2
         <a class="headerlink" href="#ejemplos-basicos-cmsis-rtos-v2" title="Link to this heading">
          &para;
         </a>
        </h1>
        <p>
         El repositorio contiene ejemplos b&aacute;sicos para entender el funcionamiento de la API CMSIS-RTOS V2 utilizando el sistema operativo RTX version 5. Los ejemplos est&aacute;n implementados para el STM32F429 y utilizan m&iacute;nimamente los perif&eacute;ricos del microcontrolador y hacer hincapi&eacute; en los conceptos de manejo del Sistema Operativo.
        </p>
        <div class="admonition note">
         <p class="admonition-title">
          Note
         </p>
         <p>
          Uso de los ejemplos
         </p>
         <p>
          Los ejemplos se han implementado para la asignatura
          <strong>
           Sistemas Basados en Microprocesador
          </strong>
          de la
          <strong>
           (ETSI Sistemas de Telecomunicaci&oacute;n) Universidad Polit&eacute;cnica de Madrid
          </strong>
          y se pueden ejecutar utilizando el simulador del microprocesador incluido en el entorno de ARM keil Microvision o bien el hardware.
         </p>
        </div>
        <section id="documentacion-en-otros-idiomas">
         <h2>
          Documentaci&oacute;n en otros idiomas
          <a class="headerlink" href="#documentacion-en-otros-idiomas" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          <a class="reference external" href="https://translate.google.com/translate?hl=en&amp;sl=es&amp;u=https://mruizglz.github.io/SBM-rtos">
           Traducci&oacute;n a ingl&eacute;s - English translation
          </a>
         </p>
        </section>
        <section id="descarga-del-codigo">
         <h2>
          Descarga del c&oacute;digo
          <a class="headerlink" href="#descarga-del-codigo" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          Para descargar el c&oacute;digo puede utilizar un cliente de git en su ordenador o bien descargar el repositorio completo (formato
          <strong>
           zip
          </strong>
          ). Las instrucciones para clonar el repositorio son:
         </p>
         <div class="admonition note">
          <p class="admonition-title">
           Note
          </p>
          <p>
           Descarga del c&oacute;digo
          </p>
          <div class="highlight-shell notranslate">
           <div class="highlight">
            <pre><span></span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/mruizglz/SBM-rtos.git
</pre>
           </div>
          </div>
         </div>
        </section>
        <section id="listado-de-ejemplos-incluidos">
         <h2>
          Listado de ejemplos incluidos
          <a class="headerlink" href="#listado-de-ejemplos-incluidos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <table class="docutils align-default" id="id1">
          <caption>
           <span class="caption-text">
            Ejemplos incluidos
           </span>
           <a class="headerlink" href="#id1" title="Link to this table">
            &para;
           </a>
          </caption>
          <thead>
           <tr class="row-odd">
            <th class="head">
             <p>
              Carpeta
             </p>
            </th>
            <th class="head">
             <p>
              Objetivos
             </p>
            </th>
           </tr>
          </thead>
          <tbody>
           <tr class="row-even">
            <td>
             <p>
              <strong>
               ejemplothreads
              </strong>
             </p>
            </td>
            <td>
             <p>
              Aprender el manejo b&aacute;sico de creaci&oacute;n de threads. Uso de la misma funci&oacute;n con par&aacute;metros parea crear multiples threads
             </p>
            </td>
           </tr>
           <tr class="row-odd">
            <td>
             <p>
              <strong>
               ejemplothreads-flags
              </strong>
             </p>
            </td>
            <td>
             <p>
              Sincronizaci&oacute;n de threads usando flags
             </p>
            </td>
           </tr>
           <tr class="row-even">
            <td>
             <p>
              <strong>
               ejemplothreads-queues
              </strong>
             </p>
            </td>
            <td>
             <p>
              Intercambio de datos entre threads usando colas
             </p>
            </td>
           </tr>
           <tr class="row-odd">
            <td>
             <p>
              <strong>
               ejemplothreads-timers
              </strong>
             </p>
            </td>
            <td>
             <p>
              Gestion de timers &ldquo;software&rdquo;
             </p>
            </td>
           </tr>
          </tbody>
         </table>
        </section>
        <section id="configuracion-del-proyecto-de-keil">
         <h2>
          Configuraci&oacute;n del Proyecto de Keil
          <a class="headerlink" href="#configuracion-del-proyecto-de-keil" title="Link to this heading">
           &para;
          </a>
         </h2>
         <section id="uso-del-simulador">
          <h3>
           Uso del simulador
           <a class="headerlink" href="#uso-del-simulador" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           ARM Keil Microvision dispone de opciones para configurar donde se ejecutar&aacute; la aplicaci&oacute;n (Icono
           <em>
            Options for Target
           </em>
           ). Seleccione
           <strong>
            Debug
           </strong>
           y active el uso del simulador (
           <strong>
            Use Simulator
           </strong>
           ).
Es necesario que configure el fichero de inicializaci&oacute;n (
           <strong>
            Initialization File
           </strong>
           ) para que cargue un script de configuraci&oacute;n del microcontrolador. En este caso, seleccione el fichero
           <code class="docutils literal notranslate">
            <span class="pre">
             simulator.ini
            </span>
           </code>
           que se encuentra en cada una de las carpetas de ejmplo. Por ejemplo en la carpeta
           <code class="docutils literal notranslate">
            <span class="pre">
             .\ejemplothreads
            </span>
           </code>
           del repositorio encontrar&aacute; el fichero
           <strong>
            simulador.ini
           </strong>
           con este contenido:
          </p>
          <div class="highlight-ini notranslate">
           <div class="highlight">
            <pre><span></span><span class="linenos">1</span><span class="na">MAP 0x40000000,0x400FFFFF read write</span>
<span class="linenos">2</span><span class="na">MAP 0xE0000000,0xE00FFFFF read write</span>
</pre>
           </div>
          </div>
          <p>
           El significado de estas instrucciones es habilitar para el simulador las operaciones de lectura/escritura en las zonas de memoria donde se encuentran los perif&eacute;ricos.
          </p>
          <div class="admonition tip">
           <p class="admonition-title">
            Tip
           </p>
           <p>
            Cuando se usa el simulador de Keil las operaciones de escritura y lectura de los perif&eacute;ricos no tienen ning&uacute;n efecto y por tanto no podr&aacute; simular el comportamiento hardware de los mismos
Todas las operaciones de la capa HAL que act&uacute;an sobre perif&eacute;ricos no tendr&aacute;n ning&uacute;n efecto. Por ejemplo, si en el c&oacute;digo se configura un pin como salida y luego se escribe un valor alto en el mismo, no podr&aacute; ver ning&uacute;n cambio en el estado del pin.
           </p>
          </div>
          <p>
           Como podr&aacute; ver en el c&oacute;digo del programa
           <code class="docutils literal notranslate">
            <span class="pre">
             main.c
            </span>
           </code>
           existe compilaci&oacute;n condicional para incluir o no el c&oacute;digo de configuraci&oacute;n del RCC para usar un reloj externo (HSE).
Si utiliza el simulador debe desactivar esta opci&oacute;n y usar el reloj interno (HSI) que es el que utiliza el simulador. La pesta&ntilde;a
           <strong>
            C/C++(AC6)
           </strong>
           permite a&ntilde;adir en
           <code class="docutils literal notranslate">
            <span class="pre">
             define
            </span>
           </code>
           etiquetas. Incluya
           <code class="docutils literal notranslate">
            <span class="pre">
             SIMULATOR
            </span>
           </code>
           si quiere utilizar el simulator.
          </p>
         </section>
         <section id="uso-del-hardware">
          <h3>
           Uso del hardware
           <a class="headerlink" href="#uso-del-hardware" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Si dispone de una placa con el microcontrolador STM32F429 puede ejecutar el c&oacute;digo directamente en el hardware. En este caso debe configurar las opciones del proyecto para que utilice el ST-Link en lugar del simulador.
          </p>
          <p>
           <strong>
            No defina la variable
           </strong>
           <code class="docutils literal notranslate">
            <span class="pre">
             SIMULATOR
            </span>
           </code>
           en las opciones de compilaci&oacute;n para que el circuito de RCC se configure adecuadamente.
          </p>
         </section>
         <section id="depuracion-de-aplicaciones-usando-cmsis-rtos-v2">
          <h3>
           Depuraci&oacute;n de aplicaciones usando CMSIS-RTOS V2
           <a class="headerlink" href="#depuracion-de-aplicaciones-usando-cmsis-rtos-v2" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           La depuraci&oacute;n de las aplicaciones se debe realizar combinando el uso de puntos de ruptura y de la aplicaci&oacute;n
           <code class="docutils literal notranslate">
            <span class="pre">
             RTX
            </span>
            <span class="pre">
             RTOS
            </span>
            <span class="pre">
             view
            </span>
           </code>
           disponible en el menu
           <code class="docutils literal notranslate">
            <span class="pre">
             View-&gt;Watch
            </span>
            <span class="pre">
             Windows-&gt;RTX
            </span>
            <span class="pre">
             RTOS
            </span>
           </code>
           .
Esta permite ver el estado en el que se encuentran los diferentes objetos del sistema operativo cuando el procesador pausa su ejecuci&oacute;n. Herramientas complementarias para entender
el funcionamiento de una aplicaci&oacute;n son:
           <code class="docutils literal notranslate">
            <span class="pre">
             Logyc
            </span>
            <span class="pre">
             Analyzer
            </span>
           </code>
           ,
           <code class="docutils literal notranslate">
            <span class="pre">
             Performance
            </span>
            <span class="pre">
             Analyzer
            </span>
           </code>
           ,
           <code class="docutils literal notranslate">
            <span class="pre">
             System
            </span>
            <span class="pre">
             Analyzer
            </span>
           </code>
           ,
           <code class="docutils literal notranslate">
            <span class="pre">
             Event
            </span>
            <span class="pre">
             Recorder
            </span>
           </code>
           .
           <code class="docutils literal notranslate">
            <span class="pre">
             Event
            </span>
            <span class="pre">
             Statistics
            </span>
           </code>
           y
           <code class="docutils literal notranslate">
            <span class="pre">
             Symbols
            </span>
            <span class="pre">
             Window
            </span>
           </code>
          </p>
         </section>
         <section id="symbols-window">
          <h3>
           Symbols Window
           <a class="headerlink" href="#symbols-window" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           La opci&oacute;n
           <strong>
            Symbols Window
           </strong>
           permite visualizar y explorar todos los s&iacute;mbolos definidos en el proyecto, incluyendo variables globales, variables est&aacute;ticas, funciones y direcciones de registros . Esta ventana es &uacute;til para depuraci&oacute;n y an&aacute;lisis en tiempo real.
          </p>
          <ul class="simple">
           <li>
            <p>
             Muestra una lista jer&aacute;rquica de todos los s&iacute;mbolos disponibles en el programa cargado.
            </p>
           </li>
           <li>
            <p>
             Permite buscar y filtrar s&iacute;mbolos por nombre.
            </p>
           </li>
           <li>
            <p>
             Muestra la direcci&oacute;n y el valor actual de cada s&iacute;mbolo durante la sesi&oacute;n de depuraci&oacute;n.
            </p>
           </li>
           <li>
            <p>
             Facilita el arrastre de variables a otras ventanas de an&aacute;lisis, como el Watch Window o el Logic Analyzer.
            </p>
           </li>
           <li>
            <p>
             Permite examinar variables optimizadas si est&aacute;n disponibles en la tabla de s&iacute;mbolos.
            </p>
           </li>
           <li>
            <p>
             Si un s&iacute;mbolo no aparece, verifique la configuraci&oacute;n de optimizaci&oacute;n del compilador y el &aacute;mbito de la variable.
            </p>
           </li>
          </ul>
          <p>
           Para utilizarlo:
          </p>
          <ol class="arabic simple">
           <li>
            <p>
             Iniciar una sesi&oacute;n de depuraci&oacute;n.
            </p>
           </li>
           <li>
            <p>
             Abrir la ventana desde el men&uacute;:
             <span class="menuselection">
              View ‣ Symbol Window
             </span>
             .
            </p>
           </li>
           <li>
            <p>
             Buscar el s&iacute;mbolo deseado utilizando el campo de filtro.
            </p>
           </li>
           <li>
            <p>
             Arrastrar el s&iacute;mbolo a la ventana de Watch o
             <code class="docutils literal notranslate">
              <span class="pre">
               Logic
              </span>
              <span class="pre">
               Analyzer
              </span>
             </code>
             para su monitorizaci&oacute;n.
            </p>
           </li>
          </ol>
         </section>
         <section id="logic-analyzer">
          <h3>
           Logic Analyzer
           <a class="headerlink" href="#logic-analyzer" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Permite visualizar la evoluci&oacute;n temporal de variables que sean globales a la aplicaci&oacute;n, el contenido de posiciones de memoria, etc. Se puede configurar el rango de valores y es muy apropiado para comparar visualmente la evoluci&oacute;n de la aplicaci&oacute;n software a trav&eacute;s del seguimiento de variables.
Para agregar se&ntilde;ales al
           <code class="docutils literal notranslate">
            <span class="pre">
             Logic
            </span>
            <span class="pre">
             Analyzer
            </span>
           </code>
           puede arrastrarlas de la ventana de s&iacute;mbolos o escribir el nombre de la misma.
          </p>
          <figure class="align-center" id="id2" style="width: 400px">
           <a class="reference internal image-reference" href="_images/logicanalyzer.png">
            <img alt="Analizador L&oacute;gico" src="_images/logicanalyzer.png" style="width: 454.0px; height: 279.0px;"/>
           </a>
           <figcaption>
            <p>
             <span class="caption-text">
              Analizador l&oacute;gico de ARM Keil Microvision.
             </span>
             <a class="headerlink" href="#id2" title="Link to this image">
              &para;
             </a>
            </p>
           </figcaption>
          </figure>
         </section>
         <section id="performance-analyzer">
          <h3>
           Performance Analyzer
           <a class="headerlink" href="#performance-analyzer" title="Link to this heading">
            &para;
           </a>
          </h3>
          <div class="admonition warning">
           <p class="admonition-title">
            Warning
           </p>
           <p>
            Solo esta disponible en Simulaci&oacute;n porque el ST-LINK no lo soporta
           </p>
          </div>
          <p>
           Permite conocer el porcentaje de tiempo utilizado por cada porci&oacute;n del c&oacute;digo de nuestra aplicaci&oacute;n.
Para utilizarlo:
          </p>
          <ol class="arabic simple">
           <li>
            <p>
             Iniciar una sesi&oacute;n de depuraci&oacute;n.
            </p>
           </li>
           <li>
            <p>
             Abrir la ventana desde el men&uacute;:
             <span class="menuselection">
              View ‣ Analysis Windows ‣ Performance analyzer
             </span>
             .
            </p>
           </li>
           <li>
            <p>
             Se muestra una lista de las diferentes secciones de c&oacute;digo.
            </p>
           </li>
          </ol>
          <figure class="align-center" style="width: 400px">
           <a class="reference internal image-reference" href="_images/performanceanalyzer.png">
            <img alt="Performance Analyzer" src="_images/performanceanalyzer.png" style="width: 423.0px; height: 192.0px;"/>
           </a>
          </figure>
         </section>
        </section>
        <section id="codigo-en-main-c-de-los-ejemplos">
         <h2>
          C&oacute;digo en main.c de los ejemplos
          <a class="headerlink" href="#codigo-en-main-c-de-los-ejemplos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          El c&oacute;digo del programa principal est&aacute; detallado a continuaci&oacute;n y es el mismo o muy similar para todos los ejemplos:
         </p>
         <blockquote>
          <div>
           <div class="highlight-c notranslate">
            <div class="highlight">
             <pre><span></span><span class="linenos">  1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"main.h"</span>
<span class="linenos">  2</span>
<span class="linenos">  3</span><span class="cp">#ifdef _RTE_</span>
<span class="linenos">  4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"RTE_Components.h"</span><span class="c1">             // Component selection</span>
<span class="linenos">  5</span><span class="cp">#endif</span>
<span class="linenos">  6</span><span class="cp">#ifdef RTE_CMSIS_RTOS2                  </span><span class="c1">// when RTE component CMSIS RTOS2 is used</span>
<span class="linenos">  7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"cmsis_os2.h"</span><span class="c1">                  // ::CMSIS:RTOS2</span>
<span class="linenos">  8</span><span class="cp">#endif</span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span><span class="cp">#ifdef RTE_CMSIS_RTOS2_RTX5</span>
<span class="linenos"> 11</span><span class="cm">/**</span>
<span class="linenos"> 12</span><span class="cm">  * Override default HAL_GetTick function</span>
<span class="linenos"> 13</span><span class="cm">  */</span>
<span class="linenos"> 14</span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">HAL_GetTick</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 15</span><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">;</span>
<span class="linenos"> 16</span><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">osKernelGetState</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">osKernelRunning</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 19</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">osKernelGetTickCount</span><span class="w"> </span><span class="p">());</span>
<span class="linenos"> 20</span><span class="w">  </span><span class="p">}</span>
<span class="linenos"> 21</span>
<span class="linenos"> 22</span><span class="w">  </span><span class="cm">/* If Kernel is not running wait approximately 1 ms then increment</span>
<span class="linenos"> 23</span><span class="cm">    and return auxiliary tick counter value */</span>
<span class="linenos"> 24</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SystemCoreClock</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">14U</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0U</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 25</span><span class="w">    </span><span class="n">__NOP</span><span class="p">();</span><span class="w"> </span><span class="n">__NOP</span><span class="p">();</span><span class="w"> </span><span class="n">__NOP</span><span class="p">();</span><span class="w"> </span><span class="n">__NOP</span><span class="p">();</span><span class="w"> </span><span class="n">__NOP</span><span class="p">();</span><span class="w"> </span><span class="n">__NOP</span><span class="p">();</span>
<span class="linenos"> 26</span><span class="w">    </span><span class="n">__NOP</span><span class="p">();</span><span class="w"> </span><span class="n">__NOP</span><span class="p">();</span><span class="w"> </span><span class="n">__NOP</span><span class="p">();</span><span class="w"> </span><span class="n">__NOP</span><span class="p">();</span><span class="w"> </span><span class="n">__NOP</span><span class="p">();</span><span class="w"> </span><span class="n">__NOP</span><span class="p">();</span>
<span class="linenos"> 27</span><span class="w">  </span><span class="p">}</span>
<span class="linenos"> 28</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">++</span><span class="n">ticks</span><span class="p">;</span>
<span class="linenos"> 29</span><span class="p">}</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="cm">/**</span>
<span class="linenos"> 32</span><span class="cm">  * Override default HAL_InitTick function</span>
<span class="linenos"> 33</span><span class="cm">  */</span>
<span class="linenos"> 34</span><span class="n">HAL_StatusTypeDef</span><span class="w"> </span><span class="nf">HAL_InitTick</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">TickPriority</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 35</span>
<span class="linenos"> 36</span><span class="w">  </span><span class="n">UNUSED</span><span class="p">(</span><span class="n">TickPriority</span><span class="p">);</span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">;</span>
<span class="linenos"> 39</span><span class="p">}</span>
<span class="linenos"> 40</span><span class="cp">#endif</span>
<span class="linenos"> 41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"Timer.h"</span>
<span class="linenos"> 42</span><span class="cm">/** @addtogroup STM32F4xx_HAL_Examples</span>
<span class="linenos"> 43</span><span class="cm">  * @{</span>
<span class="linenos"> 44</span><span class="cm">  */</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="cm">/** @addtogroup Templates</span>
<span class="linenos"> 47</span><span class="cm">  * @{</span>
<span class="linenos"> 48</span><span class="cm">  */</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="cm">/* Private typedef -----------------------------------------------------------*/</span>
<span class="linenos"> 51</span><span class="cm">/* Private define ------------------------------------------------------------*/</span>
<span class="linenos"> 52</span><span class="cm">/* Private macro -------------------------------------------------------------*/</span>
<span class="linenos"> 53</span><span class="cm">/* Private variables ---------------------------------------------------------*/</span>
<span class="linenos"> 54</span><span class="cm">/* Private function prototypes -----------------------------------------------*/</span>
<span class="linenos"> 55</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SystemClock_Config</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="linenos"> 56</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">Error_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="cm">/* Private functions ---------------------------------------------------------*/</span>
<span class="linenos"> 59</span><span class="cm">/**</span>
<span class="linenos"> 60</span><span class="cm">  * @brief  Main program</span>
<span class="linenos"> 61</span><span class="cm">  * @param  None</span>
<span class="linenos"> 62</span><span class="cm">  * @retval None</span>
<span class="linenos"> 63</span><span class="cm">  */</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos"> 66</span><span class="p">{</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="w">  </span><span class="cm">/* STM32F4xx HAL library initialization:</span>
<span class="linenos"> 69</span><span class="cm">      - Configure the Flash prefetch, Flash preread and Buffer caches</span>
<span class="linenos"> 70</span><span class="cm">      - Systick timer is configured by default as source of time base, but user</span>
<span class="linenos"> 71</span><span class="cm">            can eventually implement his proper time base source (a general purpose</span>
<span class="linenos"> 72</span><span class="cm">            timer for example or other time source), keeping in mind that Time base</span>
<span class="linenos"> 73</span><span class="cm">            duration should be kept 1ms since PPP_TIMEOUT_VALUEs are defined and</span>
<span class="linenos"> 74</span><span class="cm">            handled in milliseconds basis.</span>
<span class="linenos"> 75</span><span class="cm">      - Low Level Initialization</span>
<span class="linenos"> 76</span><span class="cm">    */</span>
<span class="linenos"> 77</span><span class="w">  </span><span class="n">HAL_Init</span><span class="p">();</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span><span class="w">  </span><span class="cm">/* Configure the system clock to 168 MHz */</span>
<span class="linenos"> 80</span><span class="w">  </span><span class="n">SystemClock_Config</span><span class="p">();</span>
<span class="linenos"> 81</span><span class="w">  </span><span class="n">SystemCoreClockUpdate</span><span class="p">();</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span><span class="w">  </span><span class="cm">/* Add your application code here</span>
<span class="linenos"> 84</span><span class="cm">    */</span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span><span class="cp">#ifdef RTE_CMSIS_RTOS2</span>
<span class="linenos"> 87</span><span class="w">  </span><span class="cm">/* Initialize CMSIS-RTOS2 */</span>
<span class="linenos"> 88</span><span class="w">  </span><span class="n">osKernelInitialize</span><span class="w"> </span><span class="p">();</span>
<span class="linenos"> 89</span>
<span class="linenos"> 90</span><span class="w">  </span><span class="cm">/* Create thread functions that start executing,</span>
<span class="linenos"> 91</span><span class="cm">  Example: osThreadNew(app_main, NULL, NULL); */</span>
<span class="linenos"> 92</span><span class="w">  </span><span class="n">Init_Threads</span><span class="p">();</span>
<span class="linenos"> 93</span><span class="w">  </span><span class="cm">/* Start thread execution */</span>
<span class="linenos"> 94</span><span class="w">  </span><span class="n">osKernelStart</span><span class="p">();</span>
<span class="linenos"> 95</span><span class="cp">#endif</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span><span class="w">  </span><span class="cm">/* Infinite loop */</span>
<span class="linenos"> 98</span><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 99</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">100</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">101</span><span class="p">}</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="cm">/**</span>
<span class="linenos">104</span><span class="cm">  * @brief  System Clock Configuration</span>
<span class="linenos">105</span><span class="cm">  *         The system Clock is configured as follow :</span>
<span class="linenos">106</span><span class="cm">  *            System Clock source            = PLL (HSE)</span>
<span class="linenos">107</span><span class="cm">  *            SYSCLK(Hz)                     = 168000000</span>
<span class="linenos">108</span><span class="cm">  *            HCLK(Hz)                       = 168000000</span>
<span class="linenos">109</span><span class="cm">  *            AHB Prescaler                  = 1</span>
<span class="linenos">110</span><span class="cm">  *            APB1 Prescaler                 = 4</span>
<span class="linenos">111</span><span class="cm">  *            APB2 Prescaler                 = 2</span>
<span class="linenos">112</span><span class="cm">  *            HSE Frequency(Hz)              = 8000000</span>
<span class="linenos">113</span><span class="cm">  *            PLL_M                          = 25</span>
<span class="linenos">114</span><span class="cm">  *            PLL_N                          = 336</span>
<span class="linenos">115</span><span class="cm">  *            PLL_P                          = 2</span>
<span class="linenos">116</span><span class="cm">  *            PLL_Q                          = 7</span>
<span class="linenos">117</span><span class="cm">  *            VDD(V)                         = 3.3</span>
<span class="linenos">118</span><span class="cm">  *            Main regulator output voltage  = Scale1 mode</span>
<span class="linenos">119</span><span class="cm">  *            Flash Latency(WS)              = 5</span>
<span class="linenos">120</span><span class="cm">  * @param  None</span>
<span class="linenos">121</span><span class="cm">  * @retval None</span>
<span class="linenos">122</span><span class="cm">  */</span>
<span class="linenos">123</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">SystemClock_Config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">124</span><span class="p">{</span>
<span class="linenos">125</span><span class="w">  </span><span class="n">RCC_ClkInitTypeDef</span><span class="w"> </span><span class="n">RCC_ClkInitStruct</span><span class="p">;</span>
<span class="linenos">126</span><span class="w">  </span><span class="n">RCC_OscInitTypeDef</span><span class="w"> </span><span class="n">RCC_OscInitStruct</span><span class="p">;</span>
<span class="linenos">127</span>
<span class="linenos">128</span><span class="w">  </span><span class="cm">/* Enable Power Control clock */</span>
<span class="linenos">129</span><span class="w">  </span><span class="n">__HAL_RCC_PWR_CLK_ENABLE</span><span class="p">();</span>
<span class="linenos">130</span>
<span class="linenos">131</span><span class="w">  </span><span class="cm">/* The voltage scaling allows optimizing the power consumption when the device is</span>
<span class="linenos">132</span><span class="cm">    clocked below the maximum system frequency, to update the voltage scaling value</span>
<span class="linenos">133</span><span class="cm">    regarding system frequency refer to product datasheet.  */</span>
<span class="linenos">134</span><span class="w">  </span><span class="n">__HAL_PWR_VOLTAGESCALING_CONFIG</span><span class="p">(</span><span class="n">PWR_REGULATOR_VOLTAGE_SCALE1</span><span class="p">);</span>
<span class="linenos">135</span>
<span class="linenos">136</span><span class="w">  </span><span class="cm">/* Enable HSE Oscillator and activate PLL with HSE as source */</span>
<span class="linenos">137</span><span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">OscillatorType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_OSCILLATORTYPE_HSE</span><span class="p">;</span>
<span class="linenos">138</span><span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">HSEState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_HSE_ON</span><span class="p">;</span>
<span class="linenos">139</span><span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_PLL_ON</span><span class="p">;</span>
<span class="linenos">140</span><span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_PLLSOURCE_HSE</span><span class="p">;</span>
<span class="linenos">141</span><span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="linenos">142</span><span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">168</span><span class="p">;</span>
<span class="linenos">143</span><span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_PLLP_DIV2</span><span class="p">;</span>
<span class="linenos">144</span><span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<span class="linenos">145</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">HAL_RCC_OscConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_OscInitStruct</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span>
<span class="linenos">146</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">147</span><span class="w">    </span><span class="cm">/* Initialization Error */</span>
<span class="linenos">148</span><span class="w">    </span><span class="n">Error_Handler</span><span class="p">();</span>
<span class="linenos">149</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="w">  </span><span class="cm">/* Select PLL as system clock source and configure the HCLK, PCLK1 and PCLK2</span>
<span class="linenos">152</span><span class="cm">    clocks dividers */</span>
<span class="linenos">153</span><span class="w">  </span><span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">ClockType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RCC_CLOCKTYPE_SYSCLK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RCC_CLOCKTYPE_HCLK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RCC_CLOCKTYPE_PCLK1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RCC_CLOCKTYPE_PCLK2</span><span class="p">);</span>
<span class="linenos">154</span><span class="w">  </span><span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">SYSCLKSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_SYSCLKSOURCE_PLLCLK</span><span class="p">;</span>
<span class="linenos">155</span><span class="w">  </span><span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">AHBCLKDivider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_SYSCLK_DIV1</span><span class="p">;</span>
<span class="linenos">156</span><span class="w">  </span><span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB1CLKDivider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_HCLK_DIV4</span><span class="p">;</span>
<span class="linenos">157</span><span class="w">  </span><span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB2CLKDivider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_HCLK_DIV2</span><span class="p">;</span>
<span class="linenos">158</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">HAL_RCC_ClockConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_ClkInitStruct</span><span class="p">,</span><span class="w"> </span><span class="n">FLASH_LATENCY_5</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span>
<span class="linenos">159</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">160</span><span class="w">    </span><span class="cm">/* Initialization Error */</span>
<span class="linenos">161</span><span class="w">    </span><span class="n">Error_Handler</span><span class="p">();</span>
<span class="linenos">162</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">163</span>
<span class="linenos">164</span><span class="w">  </span><span class="cm">/* STM32F405x/407x/415x/417x Revision Z devices: prefetch is supported */</span>
<span class="linenos">165</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_GetREVID</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x1001</span><span class="p">)</span>
<span class="linenos">166</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">167</span><span class="w">    </span><span class="cm">/* Enable the Flash prefetch */</span>
<span class="linenos">168</span><span class="w">    </span><span class="n">__HAL_FLASH_PREFETCH_BUFFER_ENABLE</span><span class="p">();</span>
<span class="linenos">169</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">170</span><span class="p">}</span>
<span class="linenos">171</span>
<span class="linenos">172</span><span class="cm">/**</span>
<span class="linenos">173</span><span class="cm">  * @brief  This function is executed in case of error occurrence.</span>
<span class="linenos">174</span><span class="cm">  * @param  None</span>
<span class="linenos">175</span><span class="cm">  * @retval None</span>
<span class="linenos">176</span><span class="cm">  */</span>
<span class="linenos">177</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">Error_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">178</span><span class="p">{</span>
<span class="linenos">179</span><span class="w">  </span><span class="cm">/* User may add here some code to deal with this error */</span>
<span class="linenos">180</span><span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">181</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">182</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">183</span><span class="p">}</span>
</pre>
            </div>
           </div>
          </div>
         </blockquote>
         <section id="algunos-detalles-importantes">
          <h3>
           Algunos detalles importantes
           <a class="headerlink" href="#algunos-detalles-importantes" title="Link to this heading">
            &para;
           </a>
          </h3>
          <blockquote>
           <div>
            <p>
             1. Al utilizar el sistema operativo CMSIS-RTOS V2 se ha definido RTE_CMSIS_RTOS2_RTX5. Esto supone incluir dos funciones que anulan las definidas anteriormente.
Estas funciones son
             <code class="docutils literal notranslate">
              <span class="pre">
               HAL_GetTick
              </span>
             </code>
             y
             <code class="docutils literal notranslate">
              <span class="pre">
               HAL_InitTick
              </span>
             </code>
             . La primera tiene dos comportamientos diferentes. Si el sistema operativo esta en ejecuci&oacute;n devuelve el valor retornado por
             <code class="docutils literal notranslate">
              <span class="pre">
               osKernelGetTickCount
              </span>
             </code>
             que indica el n&uacute;mero de ticks que han pasado desde que se arranco el SO.     * Si
             <strong>
              no
             </strong>
             se ha arrancado el SO la funci&oacute;n produce un retardo de aproximadamente 1ms e incrementa la variable est&aacute;tica
             <em>
              ticks
             </em>
             .
             <code class="docutils literal notranslate">
              <span class="pre">
               Hal_GetTick
              </span>
             </code>
             se utiliza por las librer&iacute;as HAL de STM para controlar timeouts en la gesti&oacute;n de los perif&eacute;ricos. La segunda funci&oacute;n,
             <code class="docutils literal notranslate">
              <span class="pre">
               HAL_InitTick
              </span>
             </code>
             , es usada por la capa HAL para programar un timer HW que proporcione una interrupci&oacute;n cada 1ms. Por defecto este timer es el SysTick timer.
Cuando no se usa el sistema operativo esta funci&oacute;n realiza las operaciones del c&oacute;digo descrito en
             <em>
              stm32f4xx_hal.c
             </em>
             Al usar el SO esta funci&oacute;n se substituye por la definida en el
             <code class="docutils literal notranslate">
              <span class="pre">
               main.c
              </span>
             </code>
             , que no realiza ninguna operaci&oacute;n.
Es el c&oacute;digo del sistema operativo quien se encarga de inicializar el SysTick (os_systick.c).
            </p>
            <ol class="arabic simple" start="2">
             <li>
              <p>
               Despues del c&oacute;digo de inicializaci&oacute;n de la librar&iacute;a HAL y de la configuraci&oacute;n del RCC del micro (que por cierto utiliza la funci&oacute;n HAL_GetTick) se procede a ejecutar la siguiente porci&oacute;n de c&oacute;digo:
              </p>
             </li>
            </ol>
            <div class="highlight-C notranslate">
             <div class="highlight">
              <pre><span></span><span class="linenos"> 1</span><span class="cp">#ifdef RTE_CMSIS_RTOS2</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="cm">/* Initialize CMSIS-RTOS2 */</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="n">osKernelInitialize</span><span class="w"> </span><span class="p">();</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="cm">/* Create thread functions that start executing,</span>
<span class="linenos"> 6</span><span class="cm">  Example: osThreadNew(app_main, NULL, NULL); */</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="n">Init_Threads</span><span class="p">();</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="cm">/* Start thread execution */</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">osKernelStart</span><span class="p">();</span>
<span class="linenos">10</span><span class="cp">#endif</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">  </span><span class="cm">/* Infinite loop */</span>
<span class="linenos">13</span><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">14</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">15</span><span class="w">  </span><span class="p">}</span>
</pre>
             </div>
            </div>
            <p>
             La funci&oacute;n
             <code class="docutils literal notranslate">
              <span class="pre">
               osKernelInitialize
              </span>
             </code>
             inicializa el Sistema Operativo. La funci&oacute;n
             <code class="docutils literal notranslate">
              <span class="pre">
               init_Threads
              </span>
             </code>
             contiene el c&oacute;digo de creaci&oacute;n de los recursos necesarios en este ejemplo, y
             <code class="docutils literal notranslate">
              <span class="pre">
               osKernelStart
              </span>
             </code>
             comienza la ejecuci&oacute;n de los diferentes objetos del SO sin retornar.
Eso quiere decir que la porci&oacute;n del c&oacute;digo while es c&oacute;digo muerto.
            </p>
            <ol class="arabic" start="3">
             <li>
              <p>
               Toda la inicializaci&oacute;n del hardware se debe hacer antes de lanzar la ejecuci&oacute;n del SO.
Puede incluirse en el c&oacute;digo espec&iacute;fico de cada thread, en funciones que se ejecuten entre osKernelInitialize y osKernelStart, o en funciones que se incluyan antes de llamar a osKernelInitialize. En cualquier caso debe tener cuidado con el mecanismo de retardo que utiliza en cada parte de la aplicaci&oacute;n.
              </p>
              <div class="admonition note">
               <p class="admonition-title">
                Note
               </p>
               <p>
                No se recomienda el uso de la funci&oacute;n HAL_Delay cuando se esta ejecutando el SO porque la funci&oacute;n se puede quedar bloqueada.
               </p>
              </div>
             </li>
            </ol>
           </div>
          </blockquote>
         </section>
        </section>
       </section>
       <span id="document-ejemplothread">
       </span>
       <section id="uso-basico-de-un-thread-en-cmsis-rtos-v2">
        <span id="ejemplothread">
        </span>
        <h1>
         Uso b&aacute;sico de un thread en CMSIS RTOS v2
         <a class="headerlink" href="#uso-basico-de-un-thread-en-cmsis-rtos-v2" title="Link to this heading">
          &para;
         </a>
        </h1>
        <p>
         Esta secci&oacute;n describe el funcionamiento de un programa (
         <strong>
          ejemplothread
         </strong>
         ) en C que utiliza CMSIS RTOS v2 y la biblioteca HAL de STM32 para controlar un LED mediante un hilo.
        </p>
        <section id="descripcion-general-de-ejemplothread">
         <h2>
          Descripci&oacute;n General de ejemplothread
          <a class="headerlink" href="#descripcion-general-de-ejemplothread" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          El programa crea un hilo que maneja un LED conectado al pin PB0  del microcontrolador STM32F4.El hilo alterna el estado del LED con una frecuencia configurable, utilizando funciones del sistema operativo en tiempo real (RTOS) y la biblioteca HAL para la configuraci&oacute;n y manipulaci&oacute;n de los pines GPIO.
         </p>
        </section>
        <section id="estructura-de-datos">
         <h2>
          Estructura de Datos
          <a class="headerlink" href="#estructura-de-datos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          Se define una estructura llamada
          <code class="docutils literal notranslate">
           <span class="pre">
            mygpio_pin
           </span>
          </code>
          que encapsula toda la informaci&oacute;n necesaria para controlar un LED:
         </p>
         <ul class="simple">
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              GPIO_InitTypeDef
             </span>
             <span class="pre">
              pin
             </span>
            </code>
            : configuraci&oacute;n del pin (modo, velocidad, tipo de salida).
           </p>
          </li>
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              GPIO_TypeDef
             </span>
             <span class="pre">
              *port
             </span>
            </code>
            : puerto GPIO al que pertenece el pin.
           </p>
          </li>
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              int
             </span>
             <span class="pre">
              delay
             </span>
            </code>
            : retardo en ms entre cada cambio de estado del LED.
           </p>
          </li>
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              uint8_t
             </span>
             <span class="pre">
              counter
             </span>
            </code>
            : contador que se alterna en cada iteraci&oacute;n del hilo.
           </p>
          </li>
         </ul>
         <p>
          Esta estructura permite pasar todos los par&aacute;metros necesarios a la funci&oacute;n del hilo de forma organizada.
         </p>
        </section>
        <section id="inicializacion-de-los-hilos">
         <h2>
          Inicializaci&oacute;n de los hilos
          <a class="headerlink" href="#inicializacion-de-los-hilos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Init_Thread
           </span>
          </code>
          realiza las siguientes tareas:
         </p>
         <ol class="arabic simple">
          <li>
           <p>
            Habilita el reloj del puerto GPIOB.
           </p>
          </li>
          <li>
           <p>
            Configura
            <code class="docutils literal notranslate">
             <span class="pre">
              mygpio_pin
             </span>
            </code>
            para el pin PB0.
           </p>
          </li>
          <li>
           <p>
            Crea un hilo con
            <code class="docutils literal notranslate">
             <span class="pre">
              osThreadNew
             </span>
            </code>
            , que ejecuta la funci&oacute;n
            <code class="docutils literal notranslate">
             <span class="pre">
              Thread
             </span>
            </code>
            pas&aacute;ndole una estructura
            <code class="docutils literal notranslate">
             <span class="pre">
              mygpio_pin
             </span>
            </code>
            para el pin PB0.
           </p>
          </li>
         </ol>
        </section>
        <section id="funcion-del-hilo">
         <h2>
          Funci&oacute;n del hilo
          <a class="headerlink" href="#funcion-del-hilo" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Thread
           </span>
          </code>
          realiza lo siguiente:
         </p>
         <ol class="arabic simple">
          <li>
           <p>
            Inicializa el pin GPIO usando
            <code class="docutils literal notranslate">
             <span class="pre">
              HAL_GPIO_Init
             </span>
            </code>
            .
           </p>
          </li>
          <li>
           <p>
            Entra en un bucle infinito donde:
- Alterna el valor del contador con
            <code class="docutils literal notranslate">
             <span class="pre">
              ~counter
             </span>
            </code>
            .
- Cambia el estado del pin con
            <code class="docutils literal notranslate">
             <span class="pre">
              HAL_GPIO_TogglePin
             </span>
            </code>
            .
- Espera el tiempo definido en
            <code class="docutils literal notranslate">
             <span class="pre">
              delay
             </span>
            </code>
            usando
            <code class="docutils literal notranslate">
             <span class="pre">
              osDelay
             </span>
            </code>
            .
           </p>
          </li>
         </ol>
         <p>
          Esto provoca que el LED conectado al pin correspondiente parpadee con una frecuencia que es configurable.
         </p>
        </section>
        <section id="uso-de-hal-y-cmsis-rtos">
         <h2>
          Uso de HAL y CMSIS RTOS
          <a class="headerlink" href="#uso-de-hal-y-cmsis-rtos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <ul class="simple">
          <li>
           <p>
            <strong>
             HAL (Hardware Abstraction Layer)
            </strong>
            : se utiliza para configurar e inicializar los pines GPIO de forma sencilla y portable.
           </p>
          </li>
          <li>
           <p>
            <strong>
             CMSIS RTOS v2
            </strong>
            : proporciona las funciones para crear y gestionar hilos, como
            <code class="docutils literal notranslate">
             <span class="pre">
              osThreadNew
             </span>
            </code>
            y
            <code class="docutils literal notranslate">
             <span class="pre">
              osDelay
             </span>
            </code>
            .
           </p>
          </li>
         </ul>
        </section>
        <section id="codigo-fuente">
         <h2>
          C&oacute;digo Fuente
          <a class="headerlink" href="#codigo-fuente" title="Link to this heading">
           &para;
          </a>
         </h2>
         <div class="highlight-c notranslate">
          <div class="highlight">
           <pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"cmsis_os2.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_hal.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="n">osThreadId_t</span><span class="w"> </span><span class="n">tid_Thread</span><span class="p">;</span>

<span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">led_ld1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">Pull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_NOPULL</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span>
<span class="p">};</span>



<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">pin</span><span class="p">;</span>
<span class="w">    </span><span class="n">GPIO_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">delay</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">mygpio_pin</span><span class="p">;</span>

<span class="n">mygpio_pin</span><span class="w"> </span><span class="n">pinB0</span><span class="p">;</span>


<span class="kt">int</span><span class="w"> </span><span class="nf">Init_Thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="p">();</span>

<span class="w">    </span><span class="n">pinB0</span><span class="p">.</span><span class="n">pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">led_ld1</span><span class="p">;</span>
<span class="w">    </span><span class="n">pinB0</span><span class="p">.</span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIOB</span><span class="p">;</span>
<span class="w">    </span><span class="n">pinB0</span><span class="p">.</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<span class="w">    </span><span class="n">pinB0</span><span class="p">.</span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">tid_Thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadNew</span><span class="p">(</span><span class="n">Thread</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pinB0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid_Thread</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mygpio_pin</span><span class="w"> </span><span class="o">*</span><span class="n">gpio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mygpio_pin</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">argument</span><span class="p">;</span>
<span class="w">    </span><span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">));</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">.</span><span class="n">Pin</span><span class="p">);</span>
<span class="w">        </span><span class="n">osDelay</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre>
          </div>
         </div>
        </section>
        <section id="dependencias">
         <h2>
          Dependencias
          <a class="headerlink" href="#dependencias" title="Link to this heading">
           &para;
          </a>
         </h2>
         <ul class="simple">
          <li>
           <p>
            Librer&iacute;a HAL de STM32.
           </p>
          </li>
          <li>
           <p>
            CMSIS RTOS v2.
           </p>
          </li>
         </ul>
        </section>
        <section id="preguntas-y-respuestas-sobre-ejemplothread">
         <h2>
          Preguntas y respuestas sobre ejemplothread
          <a class="headerlink" href="#preguntas-y-respuestas-sobre-ejemplothread" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          Esta secci&oacute;n contiene una serie de preguntas con sus respectivas respuestas sobre el funcionamiento del c&oacute;digo que utiliza CMSIS RTOS v2 para controlar LEDs en una placa STM32.
         </p>
         <section id="que-hace-este-codigo">
          <h3>
           &iquest;Qu&eacute; hace este c&oacute;digo?
           <a class="headerlink" href="#que-hace-este-codigo" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Este c&oacute;digo crea un hilo (thread) que controla un LED conectado al pin PB0 de una placa STM32F429. El hilo alterna el estado del LED (encendido/apagado) con una frecuencia determinada utilizando funciones del sistema operativo en tiempo real CMSIS RTOS v2.
Dentro del c&oacute;digo del Thread se realiza un casting al tipo de estructura que se utiliza en el ejemplo
          </p>
         </section>
         <section id="que-es-la-estructura-mygpio-pin">
          <h3>
           &iquest;Qu&eacute; es la estructura
           <cite>
            mygpio_pin
           </cite>
           ?
           <a class="headerlink" href="#que-es-la-estructura-mygpio-pin" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Es una estructura de datos que encapsula la informaci&oacute;n necesaria para controlar un pin GPIO en este ejemplo:
          </p>
          <ul class="simple">
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               pin
              </span>
             </code>
             : configuraci&oacute;n del pin (tipo, velocidad, modo).
            </p>
           </li>
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               port
              </span>
             </code>
             : puerto GPIO al que pertenece el pin (por ejemplo, GPIOB).
            </p>
           </li>
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               delay
              </span>
             </code>
             : retardo en ms entre cada cambio de estado (toggle).
            </p>
           </li>
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               counter
              </span>
             </code>
             : variable auxiliar que cuenta la cantidad de veces que se ha realizado el toggle.
            </p>
           </li>
          </ul>
         </section>
         <section id="como-se-inicializa-el-hilo">
          <h3>
           &iquest;C&oacute;mo se inicializa el hilo?
           <a class="headerlink" href="#como-se-inicializa-el-hilo" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           La funci&oacute;n
           <code class="docutils literal notranslate">
            <span class="pre">
             Init_Thread()
            </span>
           </code>
           habilita el reloj del puerto GPIOB, rellena los par&aacute;metros de la estructura y crea un hilo con la funci&oacute;n
           <code class="docutils literal notranslate">
            <span class="pre">
             osThreadNew()
            </span>
           </code>
           , pasando como argumento la estructura
           <code class="docutils literal notranslate">
            <span class="pre">
             mygpio_pin
            </span>
           </code>
           correspondiente a cada LED.
          </p>
         </section>
         <section id="que-hace-la-funcion-thread">
          <h3>
           &iquest;Qu&eacute; hace la funci&oacute;n
           <cite>
            Thread()
           </cite>
           ?
           <a class="headerlink" href="#que-hace-la-funcion-thread" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           La funci&oacute;n
           <code class="docutils literal notranslate">
            <span class="pre">
             Thread(void
            </span>
            <span class="pre">
             *argument)
            </span>
           </code>
           se encarga de:
          </p>
          <ol class="arabic simple">
           <li>
            <p>
             Inicializar el pin GPIO usando
             <code class="docutils literal notranslate">
              <span class="pre">
               HAL_GPIO_Init
              </span>
             </code>
             .
            </p>
           </li>
           <li>
            <p>
             Ejecutar un bucle infinito donde:
- Se incrementa el valor de
             <code class="docutils literal notranslate">
              <span class="pre">
               counter
              </span>
             </code>
             .
- Se cambia el estado del LED con
             <code class="docutils literal notranslate">
              <span class="pre">
               HAL_GPIO_TogglePin
              </span>
             </code>
             .
- Se espera el tiempo definido en
             <code class="docutils literal notranslate">
              <span class="pre">
               delay
              </span>
             </code>
             usando
             <code class="docutils literal notranslate">
              <span class="pre">
               osDelay
              </span>
             </code>
             .
            </p>
           </li>
          </ol>
         </section>
         <section id="que-significa-osdelay">
          <h3>
           &iquest;Qu&eacute; significa
           <cite>
            osDelay()
           </cite>
           ?
           <a class="headerlink" href="#que-significa-osdelay" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Es una funci&oacute;n del RTOS que suspende la ejecuci&oacute;n del hilo actual durante un n&uacute;mero determinado de ms.
Esto permite que otros hilos se ejecuten mientras tanto.
           <code class="docutils literal notranslate">
            <span class="pre">
             osDelay
            </span>
           </code>
           tiene como par&aacute;metro el n&uacute;mero de ticks que la tarea estar&aacute; bloqueada.
El n&uacute;mero de ticks por segundo se define en el archivo
           <code class="docutils literal notranslate">
            <span class="pre">
             RTX_Config.h
            </span>
           </code>
           (par&aacute;metro
           <code class="docutils literal notranslate">
            <span class="pre">
             Kernel
            </span>
            <span class="pre">
             Tick
            </span>
            <span class="pre">
             Frequency
            </span>
            <span class="pre">
             [Hz]
            </span>
           </code>
           ). En este ejemplo se ha configurado a 1000, por lo que un tick equivale a 1 ms.
          </p>
         </section>
         <section id="que-pasa-si-osthreadnew-devuelve-null">
          <h3>
           &iquest;Qu&eacute; pasa si
           <cite>
            osThreadNew()
           </cite>
           devuelve NULL?
           <a class="headerlink" href="#que-pasa-si-osthreadnew-devuelve-null" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Significa que no se pudo crear el hilo. En ese caso, la funci&oacute;n
           <code class="docutils literal notranslate">
            <span class="pre">
             Init_Thread()
            </span>
           </code>
           devuelve -1 como se&ntilde;al de error. Si el programa principal que llama a esta funci&oacute;n no comprueba el retorno no hay ning&uacute;n control de errores.
          </p>
         </section>
         <section id="que-ficheros-de-cabecera-se-utilizan">
          <h3>
           &iquest;Qu&eacute; ficheros de cabecera se utilizan?
           <a class="headerlink" href="#que-ficheros-de-cabecera-se-utilizan" title="Link to this heading">
            &para;
           </a>
          </h3>
          <ul class="simple">
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               cmsis_os2.h
              </span>
             </code>
             : para funciones del sistema operativo en tiempo real.
            </p>
           </li>
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               stm32f4xx_hal.h
              </span>
             </code>
             : para funciones de acceso a hardware (HAL).
            </p>
           </li>
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               stdlib.h
              </span>
             </code>
             : para funciones est&aacute;ndar de C que en este caso no se est&aacute;n incluyendo en el c&oacute;digo.
            </p>
           </li>
          </ul>
         </section>
         <section id="determine-la-carga-de-la-cpu-en-esta-aplicacion">
          <h3>
           Determine la carga de la CPU en esta aplicaci&oacute;n
           <a class="headerlink" href="#determine-la-carga-de-la-cpu-en-esta-aplicacion" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Para determinar la carga que supone la ejecuci&oacute;n del thread para la CPU se puede utilizar la utilidad de
           <code class="docutils literal notranslate">
            <span class="pre">
             Performance
            </span>
            <span class="pre">
             Analyzer
            </span>
           </code>
           en modo simulaci&oacute;n.
La carga de CPU obtenida es insignificante. Si se cambia en la estructura de datos el campo
           <code class="docutils literal notranslate">
            <span class="pre">
             delay
            </span>
           </code>
           por 0 la carga del Thread pasa a ser del 19%.
          </p>
         </section>
        </section>
       </section>
       <span id="document-ejemplothreads">
       </span>
       <section id="uso-basico-de-threads-en-cmsis-rtos-v2">
        <span id="ejemplothreads">
        </span>
        <h1>
         Uso b&aacute;sico de threads en CMSIS RTOS v2
         <a class="headerlink" href="#uso-basico-de-threads-en-cmsis-rtos-v2" title="Link to this heading">
          &para;
         </a>
        </h1>
        <p>
         Esta secci&oacute;n describe el funcionamiento de un programa en C que utiliza CMSIS RTOS v2 y la biblioteca HAL de STM32 para controlar dos LEDs mediante hilos concurrentes.
        </p>
        <section id="descripcion-general">
         <h2>
          Descripci&oacute;n General
          <a class="headerlink" href="#descripcion-general" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          El programa crea dos hilos que controlan dos LEDs conectados a los pines PB0 y PB7 del microcontrolador STM32F429. Cada hilo alterna el estado de su LED con una frecuencia distinta, utilizando funciones del sistema operativo en tiempo real (RTOS) y la biblioteca HAL para la configuraci&oacute;n y manipulaci&oacute;n de los pines GPIO.
         </p>
        </section>
        <section id="estructura-mygpio-pin">
         <h2>
          Estructura mygpio_pin
          <a class="headerlink" href="#estructura-mygpio-pin" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          Se define una estructura llamada
          <code class="docutils literal notranslate">
           <span class="pre">
            mygpio_pin
           </span>
          </code>
          que encapsula toda la informaci&oacute;n necesaria para controlar un LED:
         </p>
         <ul class="simple">
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              GPIO_InitTypeDef
             </span>
             <span class="pre">
              pin
             </span>
            </code>
            : configuraci&oacute;n del pin (modo, velocidad, tipo de salida).
           </p>
          </li>
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              GPIO_TypeDef
             </span>
             <span class="pre">
              *port
             </span>
            </code>
            : puerto GPIO al que pertenece el pin.
           </p>
          </li>
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              int
             </span>
             <span class="pre">
              delay
             </span>
            </code>
            : retardo en ms entre cada cambio de estado del LED.
           </p>
          </li>
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              uint8_t
             </span>
             <span class="pre">
              counter
             </span>
            </code>
            : contador que se incrementa en cada iteraci&oacute;n del hilo.
           </p>
          </li>
         </ul>
         <p>
          Esta estructura permite pasar todos los par&aacute;metros necesarios a la funci&oacute;n del hilo de forma organizada.
         </p>
        </section>
        <section id="inicializacion-de-los-threads">
         <h2>
          Inicializaci&oacute;n de los threads
          <a class="headerlink" href="#inicializacion-de-los-threads" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Init_Thread
           </span>
          </code>
          realiza las siguientes tareas:
         </p>
         <ol class="arabic simple">
          <li>
           <p>
            Habilita el reloj del puerto GPIOB.
           </p>
          </li>
          <li>
           <p>
            Configura dos instancias de
            <code class="docutils literal notranslate">
             <span class="pre">
              mygpio_pin
             </span>
            </code>
            para los pines PB0 y PB7.
           </p>
          </li>
          <li>
           <p>
            Crea dos hilos con
            <code class="docutils literal notranslate">
             <span class="pre">
              osThreadNew
             </span>
            </code>
            , cada uno ejecutando la funci&oacute;n
            <code class="docutils literal notranslate">
             <span class="pre">
              Thread
             </span>
            </code>
            con una instancia diferente de
            <code class="docutils literal notranslate">
             <span class="pre">
              mygpio_pin
             </span>
            </code>
            .
           </p>
          </li>
         </ol>
         <p>
          Cada hilo se ejecuta de forma independiente y controla su propio LED.
         </p>
        </section>
        <section id="thread">
         <h2>
          <code class="docutils literal notranslate">
           <span class="pre">
            Thread()
           </span>
          </code>
          <a class="headerlink" href="#thread" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Thread
           </span>
          </code>
          realiza lo siguiente:
         </p>
         <ol class="arabic simple">
          <li>
           <p>
            Inicializa el pin GPIO usando
            <code class="docutils literal notranslate">
             <span class="pre">
              HAL_GPIO_Init
             </span>
            </code>
            .
           </p>
          </li>
          <li>
           <p>
            Entra en un bucle infinito donde:
- Alterna el valor del contador con
            <code class="docutils literal notranslate">
             <span class="pre">
              ~counter
             </span>
            </code>
            .
- Cambia el estado del pin con
            <code class="docutils literal notranslate">
             <span class="pre">
              HAL_GPIO_TogglePin
             </span>
            </code>
            .
- Espera el tiempo definido en
            <code class="docutils literal notranslate">
             <span class="pre">
              delay
             </span>
            </code>
            usando
            <code class="docutils literal notranslate">
             <span class="pre">
              osDelay
             </span>
            </code>
            .
           </p>
          </li>
         </ol>
         <p>
          Esto provoca que el LED conectado al pin correspondiente parpadee con una frecuencia determinada.
         </p>
        </section>
        <section id="hal-y-cmsis-rtos">
         <h2>
          HAL y CMSIS RTOS
          <a class="headerlink" href="#hal-y-cmsis-rtos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <ul class="simple">
          <li>
           <p>
            <strong>
             HAL (Hardware Abstraction Layer)
            </strong>
            : se utiliza para configurar e inicializar los pines GPIO de forma sencilla y portable.
           </p>
          </li>
          <li>
           <p>
            <strong>
             CMSIS RTOS v2
            </strong>
            : proporciona las funciones para crear y gestionar hilos, como
            <code class="docutils literal notranslate">
             <span class="pre">
              osThreadNew
             </span>
            </code>
            y
            <code class="docutils literal notranslate">
             <span class="pre">
              osDelay
             </span>
            </code>
            .
           </p>
          </li>
         </ul>
        </section>
        <section id="codigo">
         <h2>
          C&oacute;digo
          <a class="headerlink" href="#codigo" title="Link to this heading">
           &para;
          </a>
         </h2>
         <div class="highlight-c notranslate">
          <div class="highlight">
           <pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"cmsis_os2.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_hal.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="n">osThreadId_t</span><span class="w"> </span><span class="n">tid_Thread</span><span class="p">;</span>

<span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">led_ld1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_0</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">Pull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_NOPULL</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span>
<span class="p">};</span>

<span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">led_ld2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_7</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">Pull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_NOPULL</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span>
<span class="p">};</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">pin</span><span class="p">;</span>
<span class="w">    </span><span class="n">GPIO_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">delay</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">mygpio_pin</span><span class="p">;</span>

<span class="n">mygpio_pin</span><span class="w"> </span><span class="n">pinB0</span><span class="p">;</span>
<span class="n">mygpio_pin</span><span class="w"> </span><span class="n">pinB7</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">Init_Thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="p">();</span>

<span class="w">    </span><span class="n">pinB0</span><span class="p">.</span><span class="n">pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">led_ld1</span><span class="p">;</span>
<span class="w">    </span><span class="n">pinB0</span><span class="p">.</span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIOB</span><span class="p">;</span>
<span class="w">    </span><span class="n">pinB0</span><span class="p">.</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<span class="w">    </span><span class="n">pinB0</span><span class="p">.</span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">tid_Thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadNew</span><span class="p">(</span><span class="n">Thread</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pinB0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid_Thread</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="n">pinB7</span><span class="p">.</span><span class="n">pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">led_ld2</span><span class="p">;</span>
<span class="w">    </span><span class="n">pinB7</span><span class="p">.</span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIOB</span><span class="p">;</span>
<span class="w">    </span><span class="n">pinB7</span><span class="p">.</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="n">pinB7</span><span class="p">.</span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">tid_Thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadNew</span><span class="p">(</span><span class="n">Thread</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pinB7</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid_Thread</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mygpio_pin</span><span class="w"> </span><span class="o">*</span><span class="n">gpio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mygpio_pin</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">argument</span><span class="p">;</span>
<span class="w">    </span><span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">));</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">pin</span><span class="p">.</span><span class="n">Pin</span><span class="p">);</span>
<span class="w">        </span><span class="n">osDelay</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre>
          </div>
         </div>
        </section>
        <section id="dependencias-software">
         <h2>
          Dependencias software
          <a class="headerlink" href="#dependencias-software" title="Link to this heading">
           &para;
          </a>
         </h2>
         <ul class="simple">
          <li>
           <p>
            Librer&iacute;a HAL de STM32.
           </p>
          </li>
          <li>
           <p>
            CMSIS RTOS v2.
           </p>
          </li>
         </ul>
        </section>
        <section id="preguntas-y-respuestas-sobre-ejemplothreads">
         <h2>
          Preguntas y respuestas sobre ejemplothreads
          <a class="headerlink" href="#preguntas-y-respuestas-sobre-ejemplothreads" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          Esta secci&oacute;n contiene una serie de preguntas con sus respectivas respuestas sobre el funcionamiento del c&oacute;digo que utiliza CMSIS RTOS v2 para controlar LEDs en una placa STM32.
         </p>
         <section id="que-funcion-hace-este-codigo">
          <h3>
           &iquest;Qu&eacute; funci&oacute;n hace este c&oacute;digo?
           <a class="headerlink" href="#que-funcion-hace-este-codigo" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Este c&oacute;digo crea dos hilos (threads) que controlan dos LEDs conectados a los pines PB0 y PB7 de una placa STM32F4. Cada hilo alterna el estado del LED (encendido/apagado) con una frecuencia determinada utilizando funciones del sistema operativo en tiempo real CMSIS RTOS v2.
Es importante entender que el mismo c&oacute;digo (funcion Thread) es ejecutado por dos hilos diferentes, cada uno con sus propios par&aacute;metros, que se reciben en el argumento de la funci&oacute;n.
Es de tipo
           <code class="docutils literal notranslate">
            <span class="pre">
             void
            </span>
           </code>
           para poder pasar cualquier tipo de estructura como argumento. Dentro del c&oacute;digo del Thread se realiza un casting al tipo de estructura que se utiliza en el ejemplo
          </p>
         </section>
         <section id="que-funcion-tiene-mygpio-pin">
          <h3>
           &iquest;Qu&eacute;  funci&oacute;n tiene
           <cite>
            mygpio_pin
           </cite>
           ?
           <a class="headerlink" href="#que-funcion-tiene-mygpio-pin" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Es una estructura de datos que encapsula la informaci&oacute;n necesaria para controlar un pin GPIO en este ejemplo:
          </p>
          <ul class="simple">
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               pin
              </span>
             </code>
             : configuraci&oacute;n del pin (tipo, velocidad, modo).
            </p>
           </li>
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               port
              </span>
             </code>
             : puerto GPIO al que pertenece el pin (por ejemplo, GPIOB).
            </p>
           </li>
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               delay
              </span>
             </code>
             : retardo en ms entre cada cambio de estado (toggle).
            </p>
           </li>
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               counter
              </span>
             </code>
             : variable auxiliar que cuenta la cantidad de veces que se ha realizado el toggle.
            </p>
           </li>
          </ul>
         </section>
         <section id="como-se-inicializan-los-hilos">
          <h3>
           &iquest;C&oacute;mo se inicializan los hilos?
           <a class="headerlink" href="#como-se-inicializan-los-hilos" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           La funci&oacute;n
           <code class="docutils literal notranslate">
            <span class="pre">
             Init_Thread()
            </span>
           </code>
           habilita el reloj del puerto GPIOB, configura los par&aacute;metros de cada LED y crea dos hilos con
           <code class="docutils literal notranslate">
            <span class="pre">
             osThreadNew()
            </span>
           </code>
           , pasando como argumento la estructura
           <code class="docutils literal notranslate">
            <span class="pre">
             mygpio_pin
            </span>
           </code>
           correspondiente a cada LED.
          </p>
         </section>
         <section id="que-funcion-tieneo-thread">
          <h3>
           &iquest;Qu&eacute; funci&oacute;n tiene&ordm;
           <cite>
            Thread()
           </cite>
           ?
           <a class="headerlink" href="#que-funcion-tieneo-thread" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           La funci&oacute;n
           <code class="docutils literal notranslate">
            <span class="pre">
             Thread(void
            </span>
            <span class="pre">
             *argument)
            </span>
           </code>
           es ejecutada por cada hilo. Dentro de ella:
          </p>
          <ol class="arabic simple">
           <li>
            <p>
             Se inicializa el pin GPIO usando
             <code class="docutils literal notranslate">
              <span class="pre">
               HAL_GPIO_Init
              </span>
             </code>
             .
            </p>
           </li>
           <li>
            <p>
             Se entra en un bucle infinito donde:
- Se alterna el valor de
             <code class="docutils literal notranslate">
              <span class="pre">
               counter
              </span>
             </code>
             .
- Se cambia el estado del LED con
             <code class="docutils literal notranslate">
              <span class="pre">
               HAL_GPIO_TogglePin
              </span>
             </code>
             .
- Se espera el tiempo definido en
             <code class="docutils literal notranslate">
              <span class="pre">
               delay
              </span>
             </code>
             usando
             <code class="docutils literal notranslate">
              <span class="pre">
               osDelay
              </span>
             </code>
             .
            </p>
           </li>
          </ol>
         </section>
         <section id="se-ejecutan-los-hilos-al-mismo-tiempo">
          <h3>
           &iquest;Se ejecutan los hilos al mismo tiempo?
           <a class="headerlink" href="#se-ejecutan-los-hilos-al-mismo-tiempo" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           CMSIS RTOS v2 permite la ejecuci&oacute;n concurrente, que no simultanea, de m&uacute;ltiples hilos. El scheduler del sistema operativo se encarga de asignar tiempo de CPU a cada hilo seg&uacute;n su estado y prioridad.
          </p>
         </section>
         <section id="que-funcion-tiene-osdelay">
          <h3>
           &iquest;Qu&eacute; funci&oacute;n tiene
           <code class="docutils literal notranslate">
            <span class="pre">
             osDelay()
            </span>
           </code>
           <a class="headerlink" href="#que-funcion-tiene-osdelay" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Es una funci&oacute;n del RTOS que suspende la ejecuci&oacute;n del hilo actual durante un n&uacute;mero determinado de ticks. Esto permite que otros hilos se ejecuten mientras tanto.
           <code class="docutils literal notranslate">
            <span class="pre">
             osDelay
            </span>
           </code>
           tiene como parametro el n&uacute;mero de ticks que la tarea estar&aacute; bloqueada. El n&uacute;mero de ticks por segundo se define en el archivo
           <code class="docutils literal notranslate">
            <span class="pre">
             RTX_Config.h
            </span>
           </code>
           (par&aacute;metro
           <code class="docutils literal notranslate">
            <span class="pre">
             Kernel
            </span>
            <span class="pre">
             Tick
            </span>
            <span class="pre">
             Frequency
            </span>
            <span class="pre">
             [Hz]
            </span>
           </code>
           ). En este ejemplo se ha configurado a 1000, por lo que un tick equivale a 1 ms.
          </p>
         </section>
         <section id="que-pasa-si-osthreadnew-retorna-null">
          <h3>
           &iquest;Qu&eacute; pasa si
           <cite>
            osThreadNew()
           </cite>
           retorna NULL?
           <a class="headerlink" href="#que-pasa-si-osthreadnew-retorna-null" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Significa que no se pudo crear el hilo. En ese caso, la funci&oacute;n
           <code class="docutils literal notranslate">
            <span class="pre">
             Init_Thread()
            </span>
           </code>
           devuelve
           <em>
            -1
           </em>
           como se&ntilde;al de error.
          </p>
         </section>
         <section id="que-includes-se-utilizan">
          <h3>
           &iquest;Qu&eacute; includes se utilizan?
           <a class="headerlink" href="#que-includes-se-utilizan" title="Link to this heading">
            &para;
           </a>
          </h3>
          <ul class="simple">
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               cmsis_os2.h
              </span>
             </code>
             : para funciones del sistema operativo en tiempo real.
            </p>
           </li>
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               stm32f4xx_hal.h
              </span>
             </code>
             : para funciones de acceso a hardware (HAL).
            </p>
           </li>
           <li>
            <p>
             <code class="docutils literal notranslate">
              <span class="pre">
               stdlib.h
              </span>
             </code>
             : para funciones est&aacute;ndar de C.
            </p>
           </li>
          </ul>
         </section>
         <section id="cuanto-vale-el-valor-del-tick-es-esta-aplicacion">
          <h3>
           &iquest;Cuanto vale el valor del tick es esta aplicaci&oacute;n?
           <a class="headerlink" href="#cuanto-vale-el-valor-del-tick-es-esta-aplicacion" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           El fichero de configuraci&oacute;n del sistema operativo tal y como indica la figura tiene configurado un tick de 1ms.
          </p>
          <figure class="align-center" id="id1" style="width: 400px">
           <a class="reference internal image-reference" href="_images/RTXConfig.png">
            <img alt="_images/RTXConfig.png" src="_images/RTXConfig.png" style="width: 401.5px; height: 216.0px;"/>
           </a>
           <figcaption>
            <p>
             <span class="caption-text">
              Configuraci&oacute;n del sistema operativo.
             </span>
             <a class="headerlink" href="#id1" title="Link to this image">
              &para;
             </a>
            </p>
           </figcaption>
          </figure>
         </section>
         <section id="que-es-el-thread-idle-que-tamano-de-stack-tiene-y-otro-thread-que-tamano-de-stack-usa">
          <h3>
           &iquest;Que es el thread Idle? &iquest;Qu&eacute; tama&ntilde;o de stack tiene? &iquest;Y otro thread? &iquest;Que tama&ntilde;o de stack usa?
           <a class="headerlink" href="#que-es-el-thread-idle-que-tamano-de-stack-tiene-y-otro-thread-que-tamano-de-stack-usa" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           El thread idle esta definido en el fichero RTX_Config.c y es un thread que se ejecuta cuando el sistema operativo no tiene ninguna otro thread que ejecutar. Tiene un tama&ntilde;o de
           <code class="docutils literal notranslate">
            <span class="pre">
             stack
            </span>
           </code>
           de 512 bytes.
Cualquier otro thread se configura para tener un tama&ntilde;o de stack de 3072 bytes (3KBytes). Una reflexi&oacute;n interesante es cuantos threads se pueden crear en una aplicaci&oacute;n.
          </p>
         </section>
        </section>
       </section>
       <span id="document-ejemplothreads-queues">
       </span>
       <section id="uso-basico-de-threads-y-colas-en-cmsis-rtos-v2">
        <h1>
         Uso b&aacute;sico de threads y colas en CMSIS RTOS v2
         <a class="headerlink" href="#uso-basico-de-threads-y-colas-en-cmsis-rtos-v2" title="Link to this heading">
          &para;
         </a>
        </h1>
        <p>
         Este documento describe el funcionamiento de un programa en C que utiliza CMSIS RTOS v2 y la biblioteca HAL de STM32 para controlar dos LEDs mediante hilos concurrentes que se comunican con colas.
        </p>
        <section id="descripcion-general">
         <h2>
          Descripci&oacute;n General
          <a class="headerlink" href="#descripcion-general" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          El programa crea dos hilos, denominados
          <code class="docutils literal notranslate">
           <span class="pre">
            Producer
           </span>
          </code>
          y
          <code class="docutils literal notranslate">
           <span class="pre">
            Consumer
           </span>
          </code>
          . El hilo
          <code class="docutils literal notranslate">
           <span class="pre">
            Producer
           </span>
          </code>
          se encarga de introducir datos en la cola que tiene el identificador
          <code class="docutils literal notranslate">
           <span class="pre">
            id_MsgQueue
           </span>
          </code>
          .
El numero total de mensajes que se introducen en la cola en cada iteraci&oacute;n del bucle
          <code class="docutils literal notranslate">
           <span class="pre">
            while
           </span>
          </code>
          es 32 con un tiempo de retardo entre operaciones de escritura que es variable
El
          <code class="docutils literal notranslate">
           <span class="pre">
            Consumer
           </span>
          </code>
          se encarga de extraer los datos de cola y de actuar sobre los leds en funci&oacute;n del valor leido de la cola.
         </p>
        </section>
        <section id="estructuras-de-datos">
         <h2>
          Estructuras de Datos
          <a class="headerlink" href="#estructuras-de-datos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          Se define una estructura llamada
          <code class="docutils literal notranslate">
           <span class="pre">
            mygpio_pin
           </span>
          </code>
          que encapsula toda la informaci&oacute;n necesaria para controlar un LED:
         </p>
         <ul class="simple">
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              GPIO_InitTypeDef
             </span>
             <span class="pre">
              pin
             </span>
            </code>
            : configuraci&oacute;n del pin (modo, velocidad, tipo de salida).
           </p>
          </li>
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              GPIO_TypeDef
             </span>
             <span class="pre">
              *port
             </span>
            </code>
            : puerto GPIO al que pertenece el pin.
           </p>
          </li>
         </ul>
         <p>
          Esta estructura permite pasar todos los par&aacute;metros necesarios a la funci&oacute;n del hilo de forma organizada.
         </p>
        </section>
        <section id="creacion-hilos">
         <h2>
          Creaci&oacute;n Hilos
          <a class="headerlink" href="#creacion-hilos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Init_Thread
           </span>
          </code>
          realiza las siguientes operaciones:
         </p>
         <ol class="arabic simple">
          <li>
           <p>
            Crea una cola con
            <code class="docutils literal notranslate">
             <span class="pre">
              osMessageQueueNew
             </span>
            </code>
            para almacenar hasta 16 mensajes cada uno de tama&ntilde;o un
            <code class="docutils literal notranslate">
             <span class="pre">
              uint8_t
             </span>
            </code>
            , es decir, un solo byte.
           </p>
          </li>
          <li>
           <p>
            Crea un hilo
            <code class="docutils literal notranslate">
             <span class="pre">
              Consumer
             </span>
            </code>
            con
            <code class="docutils literal notranslate">
             <span class="pre">
              osThreadNew
             </span>
            </code>
            , ejecutando la funci&oacute;n
            <code class="docutils literal notranslate">
             <span class="pre">
              Consumer
             </span>
            </code>
            .
           </p>
          </li>
          <li>
           <p>
            Crea un hilo
            <code class="docutils literal notranslate">
             <span class="pre">
              Producer
             </span>
            </code>
            con
            <code class="docutils literal notranslate">
             <span class="pre">
              osThreadNew
             </span>
            </code>
            , ejecutando la funci&oacute;n
            <code class="docutils literal notranslate">
             <span class="pre">
              Producer
             </span>
            </code>
            .
           </p>
          </li>
         </ol>
        </section>
        <section id="producer">
         <h2>
          Producer
          <a class="headerlink" href="#producer" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Producer(void
           </span>
           <span class="pre">
            *argument)
           </span>
          </code>
          realiza las siguientes operaciones:
1. De manera continua en un bucle infinito inserta en cola en cada iteraci&oacute;n del bucle while 32 mensajes de 1 byte con el valor de la variable index.
2. Los mensajes se introducen con un retardo que varia desde 100ms hasta 400ms
3. La funci&oacute;n osMessageQueuePut introduce los mensajes con timeout 0, lo c&uacute;al implica que si no hay sitio en la cola el mensaje no se podr&aacute; guardar.
         </p>
        </section>
        <section id="consumer">
         <h2>
          Consumer
          <a class="headerlink" href="#consumer" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Consumer(void
           </span>
           <span class="pre">
            *argument)
           </span>
          </code>
          realiza las siguientes operaciones:
1. De manera continua en un bucle infinito extrae de la cola los mensajes introducidos por el hilo
          <code class="docutils literal notranslate">
           <span class="pre">
            Producer
           </span>
          </code>
          .
2. Si se saca un valor de la cola se procede a encender o apagar los leds en funci&oacute;n del valor leido.
3. La variable errors_or_timeout cuenta el n&uacute;mero de veces que no se ha podido leer un mensaje de la cola, ya sea por timeout o porque la cola est&aacute; vac&iacute;a.
         </p>
        </section>
        <section id="hal-cmsis-rtos">
         <h2>
          HAL-CMSIS RTOS
          <a class="headerlink" href="#hal-cmsis-rtos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <ul class="simple">
          <li>
           <p>
            <strong>
             HAL (Hardware Abstraction Layer)
            </strong>
            : se utiliza para configurar e inicializar los pines GPIO de forma sencilla y portable.
           </p>
          </li>
          <li>
           <p>
            <strong>
             CMSIS RTOS v2
            </strong>
            : proporciona las funciones para crear y gestionar hilos, como
            <code class="docutils literal notranslate">
             <span class="pre">
              osThreadNew
             </span>
            </code>
            y
            <code class="docutils literal notranslate">
             <span class="pre">
              osDelay
             </span>
            </code>
            , y las funciones para gestionar las colas.
           </p>
          </li>
         </ul>
        </section>
        <section id="fuente">
         <h2>
          Fuente
          <a class="headerlink" href="#fuente" title="Link to this heading">
           &para;
          </a>
         </h2>
         <div class="highlight-c notranslate">
          <div class="highlight">
           <pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"cmsis_os2.h"</span><span class="c1">                          // CMSIS RTOS header file</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_hal.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>


<span class="n">osThreadId_t</span><span class="w"> </span><span class="n">tid_Thread</span><span class="p">;</span><span class="w">                        </span><span class="c1">// thread id</span>
<span class="n">osMessageQueueId_t</span><span class="w"> </span><span class="n">id_MsgQueue</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">Init_Thread</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">Producer</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">);</span><span class="w">                   </span><span class="c1">// thread function producing data</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">Consumer</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">);</span><span class="w">                   </span><span class="c1">// thread function consuming data</span>
<span class="kt">int</span><span class="w"> </span><span class="n">qsize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">h</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w">  </span><span class="p">{</span>
<span class="w">        </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">pin</span><span class="p">;</span>
<span class="w">                </span><span class="n">GPIO_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">mygpio_pin</span><span class="p">;</span>

<span class="n">mygpio_pin</span><span class="w"> </span><span class="n">pinB0</span><span class="p">;</span>
<span class="n">mygpio_pin</span><span class="w"> </span><span class="n">pinB7</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">Init_Thread</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">id_MsgQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osMessageQueueNew</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>


<span class="n">tid_Thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadNew</span><span class="p">(</span><span class="n">Producer</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid_Thread</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="p">}</span>

<span class="w">        </span><span class="n">tid_Thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadNew</span><span class="p">(</span><span class="n">Consumer</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid_Thread</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Producer</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">osStatus_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">h</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">h</span><span class="o">++</span><span class="p">){</span>
<span class="w">                        </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">                                </span><span class="n">status</span><span class="o">=</span><span class="n">osMessageQueuePut</span><span class="p">(</span><span class="n">id_MsgQueue</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mi">0U</span><span class="p">,</span><span class="w"> </span><span class="mi">0U</span><span class="p">);</span>
<span class="w">                                </span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
<span class="w">                                </span><span class="n">osDelay</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">Consumer</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">val</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">osStatus_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">errors_or_timeouts</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">led_ld1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="p">.</span><span class="n">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_0</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Pull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_NOPULL</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">led_ld2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="p">.</span><span class="n">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_7</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Pull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_NOPULL</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="p">();</span>

<span class="w">        </span><span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">led_ld1</span><span class="p">);</span>

<span class="w">        </span><span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">led_ld2</span><span class="p">);</span>


<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">qsize</span><span class="o">=</span><span class="n">osMessageQueueGetCount</span><span class="w"> </span><span class="p">(</span><span class="n">id_MsgQueue</span><span class="p">);</span>
<span class="w">                </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osMessageQueueGet</span><span class="p">(</span><span class="n">id_MsgQueue</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">10U</span><span class="p">);</span><span class="w">   </span><span class="c1">// wait for message</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">osOK</span><span class="p">){</span>
<span class="w">                        </span><span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="n">led_ld1</span><span class="p">.</span><span class="n">Pin</span><span class="p">,(</span><span class="n">GPIO_PinState</span><span class="p">)</span><span class="w"> </span><span class="n">val</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">);</span>
<span class="w">                        </span><span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="n">led_ld2</span><span class="p">.</span><span class="n">Pin</span><span class="p">,(</span><span class="n">GPIO_PinState</span><span class="p">)(</span><span class="n">val</span><span class="o">&amp;</span><span class="mh">0x02</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>

<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">errors_or_timeouts</span><span class="o">++</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span><span class="w"> </span><span class="c1">//This delay is to simulate an operation that needs 101ms to complete</span>

<span class="p">}</span>
<span class="p">}</span>
</pre>
          </div>
         </div>
        </section>
        <section id="dependencias-de-software">
         <h2>
          Dependencias de software
          <a class="headerlink" href="#dependencias-de-software" title="Link to this heading">
           &para;
          </a>
         </h2>
         <ul class="simple">
          <li>
           <p>
            Librer&iacute;a HAL de STM32.
           </p>
          </li>
          <li>
           <p>
            CMSIS RTOS v2.
           </p>
          </li>
         </ul>
        </section>
        <section id="preguntas-y-respuestas-sobre-ejemplothreads-queues">
         <h2>
          Preguntas y respuestas sobre ejemplothreads-queues
          <a class="headerlink" href="#preguntas-y-respuestas-sobre-ejemplothreads-queues" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          Esta secci&oacute;n contiene una serie de preguntas con sus respectivas respuestas sobre el funcionamiento del c&oacute;digo que utiliza CMSIS RTOS v2 para controlar LEDs en una placa STM32.
         </p>
         <section id="cual-es-el-proposito-de-la-cola-de-mensajes-id-msgqueue-en-esta-aplicacion">
          <h3>
           &iquest;Cu&aacute;l es el prop&oacute;sito de la cola de mensajes
           <cite>
            id_MsgQueue
           </cite>
           en esta aplicaci&oacute;n?
           <a class="headerlink" href="#cual-es-el-proposito-de-la-cola-de-mensajes-id-msgqueue-en-esta-aplicacion" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           La cola de mensajes
           <cite>
            id_MsgQueue
           </cite>
           act&uacute;a como un canal de comunicaci&oacute;n y sincronizaci&oacute;n entre los hilos
           <cite>
            Producer
           </cite>
           y
           <cite>
            Consumer
           </cite>
           . Permite que el hilo productor env&iacute;e datos (&iacute;ndices) al consumidor de forma segura y sincronizada. Al definir una cola con capacidad para 16 elementos de tipo
           <cite>
            uint8_t
           </cite>
           , se establece un buffer temporal que desacopla la producci&oacute;n y el consumo de datos.
          </p>
         </section>
         <section id="que-funcion-cumple-el-bucle-anidado-en-el-hilo-producer">
          <h3>
           &iquest;Qu&eacute; funci&oacute;n cumple el bucle anidado en el hilo
           <cite>
            Producer
           </cite>
           ?
           <a class="headerlink" href="#que-funcion-cumple-el-bucle-anidado-en-el-hilo-producer" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           El bucle anidado en
           <cite>
            Producer
           </cite>
           genera una secuencia de valores que se colocan en la cola de mensajes. El bucle externo recorre
           <cite>
            h
           </cite>
           de 1 a 4, y el interno recorre
           <cite>
            i
           </cite>
           de 0 a 7. En cada iteraci&oacute;n, se coloca un valor en la cola (
           <cite>
            index
           </cite>
           ) y se incrementa. El retardo
           <cite>
            osDelay(h*100)
           </cite>
           introduce una variabilidad en el tiempo entre env&iacute;os, oscilando entre 100 ms y 400 ms. Esto simula diferentes tasas de producci&oacute;n de datos.
          </p>
         </section>
         <section id="cuanto-tiempo-tarda-en-llenarse-la-cola-de-mensajes-id-msgqueue">
          <h3>
           &iquest;Cuanto tiempo tarda en llenarse la cola de mensajes
           <cite>
            id_MsgQueue
           </cite>
           ?
           <a class="headerlink" href="#cuanto-tiempo-tarda-en-llenarse-la-cola-de-mensajes-id-msgqueue" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           En la cola se introducen 32 mensajes en cada ciclo completo de los bucles anidados (8 mensajes por cada uno de los 4 valores de
           <cite>
            h
           </cite>
           ) pero el Thread Consumer extrae mensajes cada 250ms en el caso de que existan. Por tanto la cola nunca llega a llenarse.
Intente calcular cual ser&iacute;a el numero m&aacute;ximo de mensajes que se pueden acumular en la cola.
          </p>
         </section>
         <section id="cuanto-vale-la-variable-errors-or-timeouts-despues-de-1-minuto-de-ejecucion-del-codigo">
          <h3>
           &iquest;cuanto vale la variable errors_or_timeouts despues de 1 minuto de ejecuci&oacute;n del c&oacute;digo?
           <a class="headerlink" href="#cuanto-vale-la-variable-errors-or-timeouts-despues-de-1-minuto-de-ejecucion-del-codigo" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           Vale 0 porque no se produce dicha condici&oacute;n nunca.
          </p>
          <div class="admonition note">
           <p class="admonition-title">
            Note
           </p>
           <p>
            Challenge: Modifique el c&oacute;digo del hilo
            <code class="docutils literal notranslate">
             <span class="pre">
              Producer
             </span>
            </code>
            para que la variable errors_or_timeouts no valga cero.
           </p>
          </div>
         </section>
        </section>
       </section>
       <span id="document-ejemplothreads-flags">
       </span>
       <section id="uso-basico-de-threads-y-flags-en-cmsis-rtos-v2">
        <h1>
         Uso b&aacute;sico de threads y flags en CMSIS RTOS v2
         <a class="headerlink" href="#uso-basico-de-threads-y-flags-en-cmsis-rtos-v2" title="Link to this heading">
          &para;
         </a>
        </h1>
        <p>
         Este documento describe el funcionamiento de un programa en C que utiliza CMSIS RTOS v2 y la biblioteca HAL de STM32 para controlar dos LEDs mediante hilos concurrentes que se sincronizan con flags.
        </p>
        <section id="descripcion">
         <h2>
          Descripci&oacute;n
          <a class="headerlink" href="#descripcion" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          El programa crea dos hilos, denominados
          <code class="docutils literal notranslate">
           <span class="pre">
            Producer
           </span>
          </code>
          y
          <code class="docutils literal notranslate">
           <span class="pre">
            Consumer
           </span>
          </code>
          .  El hilo
          <code class="docutils literal notranslate">
           <span class="pre">
            Producer
           </span>
          </code>
          es un bucle infinito que se encarga de activar flags para el thread
          <code class="docutils literal notranslate">
           <span class="pre">
            Consumer
           </span>
          </code>
          . Este en funci&oacute;n de los flags activados ejecuta unas acciones u otras.
         </p>
         <p>
          Se define una estructura llamada
          <code class="docutils literal notranslate">
           <span class="pre">
            mygpio_pin
           </span>
          </code>
          que encapsula toda la informaci&oacute;n necesaria para controlar un LED:
         </p>
         <ul class="simple">
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              GPIO_InitTypeDef
             </span>
             <span class="pre">
              pin
             </span>
            </code>
            : configuraci&oacute;n del pin (modo, velocidad, tipo de salida).
           </p>
          </li>
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              GPIO_TypeDef
             </span>
             <span class="pre">
              *port
             </span>
            </code>
            : puerto GPIO al que pertenece el pin.
           </p>
          </li>
         </ul>
         <p>
          Esta estructura permite pasar todos los par&aacute;metros necesarios a la funci&oacute;n del hilo de forma organizada.
         </p>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Init_Thread
           </span>
          </code>
          realiza las siguientes operaciones:
         </p>
         <p>
          1. Crea un hilo
          <code class="docutils literal notranslate">
           <span class="pre">
            Consumer
           </span>
          </code>
          con
          <code class="docutils literal notranslate">
           <span class="pre">
            osThreadNew
           </span>
          </code>
          , ejecutando la funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Consumer
           </span>
          </code>
          .
3. Crea un hilo
          <code class="docutils literal notranslate">
           <span class="pre">
            Producer
           </span>
          </code>
          con
          <code class="docutils literal notranslate">
           <span class="pre">
            osThreadNew
           </span>
          </code>
          , ejecutando la funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Producer
           </span>
          </code>
          .
         </p>
        </section>
        <section id="funcion-del-hilo-producer">
         <h2>
          Funci&oacute;n del hilo Producer
          <a class="headerlink" href="#funcion-del-hilo-producer" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Producer(void
           </span>
           <span class="pre">
            *argument)
           </span>
          </code>
          realiza las siguientes operaciones:
1. De manera continua en un bucle infinito se&ntilde;aliza flags en el thread
          <code class="docutils literal notranslate">
           <span class="pre">
            Consumer
           </span>
          </code>
          .
2. Los flags activados son el 0x0001 y en 0x0002.
         </p>
        </section>
        <section id="funcion-del-hilo-consumer">
         <h2>
          Funci&oacute;n del hilo Consumer
          <a class="headerlink" href="#funcion-del-hilo-consumer" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Consumer(void
           </span>
           <span class="pre">
            *argument)
           </span>
          </code>
          realiza las siguientes operaciones:
1. Inticializa  dos pines del GPIO en el puerto B.
2. Espera de manera infinita (
          <code class="docutils literal notranslate">
           <span class="pre">
            osWaitForEver
           </span>
          </code>
          ) a que cualquiera  (
          <code class="docutils literal notranslate">
           <span class="pre">
            osFlagsWaitAny
           </span>
          </code>
          ) de los flags (
          <code class="docutils literal notranslate">
           <span class="pre">
            0
           </span>
          </code>
          o
          <code class="docutils literal notranslate">
           <span class="pre">
            1
           </span>
          </code>
          , en hexadecimal
          <code class="docutils literal notranslate">
           <span class="pre">
            0x03
           </span>
          </code>
          ) se activen.
3. Si el flag activado es el
          <code class="docutils literal notranslate">
           <span class="pre">
            0
           </span>
          </code>
          se hace un toggle en el pin 0 del GPIOB. Si el activado es el
          <code class="docutils literal notranslate">
           <span class="pre">
            1
           </span>
          </code>
          se hace el toggle en el pin 7 del GPIOB.
4. Si se produce otra condici&oacute;n se incrementa la variable
          <code class="docutils literal notranslate">
           <span class="pre">
            errors
           </span>
          </code>
          .
         </p>
        </section>
        <section id="hal-y-cmsis-rtos">
         <h2>
          HAL y CMSIS RTOS
          <a class="headerlink" href="#hal-y-cmsis-rtos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <ul class="simple">
          <li>
           <p>
            <strong>
             HAL (Hardware Abstraction Layer)
            </strong>
            : se utiliza para configurar e inicializar los pines GPIO de forma sencilla y portable.
           </p>
          </li>
          <li>
           <p>
            <strong>
             CMSIS RTOS v2
            </strong>
            : proporciona las funciones para crear y gestionar hilos, como
            <code class="docutils literal notranslate">
             <span class="pre">
              osThreadNew
             </span>
            </code>
            y
            <code class="docutils literal notranslate">
             <span class="pre">
              osDelay
             </span>
            </code>
            , y la funciones de gestion de los flags.
           </p>
          </li>
         </ul>
        </section>
        <section id="codigo-aplicacion">
         <h2>
          C&oacute;digo aplicaci&oacute;n
          <a class="headerlink" href="#codigo-aplicacion" title="Link to this heading">
           &para;
          </a>
         </h2>
         <div class="highlight-c notranslate">
          <div class="highlight">
           <pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"cmsis_os2.h"</span><span class="c1">                          // CMSIS RTOS header file</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_hal.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>


<span class="n">osThreadId_t</span><span class="w"> </span><span class="n">tid_Thread_producer</span><span class="p">;</span><span class="w">                        </span><span class="c1">// thread id</span>
<span class="n">osThreadId_t</span><span class="w"> </span><span class="n">tid_Thread_consumer</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">Init_Thread</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">Producer</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">);</span><span class="w">                   </span><span class="c1">// thread function producing data</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">Consumer</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">);</span><span class="w">                   </span><span class="c1">// thread function consuming data</span>
<span class="kt">int</span><span class="w"> </span><span class="n">qsize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w">  </span><span class="p">{</span>
<span class="w">        </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">pin</span><span class="p">;</span>
<span class="w">                </span><span class="n">GPIO_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">mygpio_pin</span><span class="p">;</span>

<span class="n">mygpio_pin</span><span class="w"> </span><span class="n">pinB0</span><span class="p">;</span>
<span class="n">mygpio_pin</span><span class="w"> </span><span class="n">pinB7</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">Init_Thread</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>




<span class="n">tid_Thread_producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadNew</span><span class="p">(</span><span class="n">Producer</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid_Thread_producer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="p">}</span>

<span class="w">        </span><span class="n">tid_Thread_consumer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadNew</span><span class="p">(</span><span class="n">Consumer</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid_Thread_consumer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">Producer</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>


<span class="w">        </span><span class="n">status</span><span class="o">=</span><span class="w"> </span><span class="n">osThreadFlagsSet</span><span class="p">(</span><span class="n">tid_Thread_consumer</span><span class="p">,</span><span class="mh">0x0001</span><span class="p">);</span>
<span class="w">        </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="w">        </span><span class="n">status</span><span class="o">=</span><span class="w"> </span><span class="n">osThreadFlagsSet</span><span class="p">(</span><span class="n">tid_Thread_consumer</span><span class="p">,</span><span class="mh">0x0002</span><span class="p">);</span>
<span class="w">        </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

<span class="w">        </span><span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">Consumer</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">val</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">errors</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">led_ld1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="p">.</span><span class="n">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_0</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Pull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_NOPULL</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">led_ld2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="p">.</span><span class="n">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_7</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Pull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_NOPULL</span><span class="p">,</span>
<span class="w">                </span><span class="p">.</span><span class="n">Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="p">();</span>

<span class="w">        </span><span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">led_ld1</span><span class="p">);</span>

<span class="w">        </span><span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">led_ld2</span><span class="p">);</span>


<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">status</span><span class="o">=</span><span class="n">osThreadFlagsWait</span><span class="p">(</span><span class="mh">0x3</span><span class="p">,</span><span class="n">osFlagsWaitAny</span><span class="p">,</span><span class="n">osWaitForever</span><span class="p">);</span>
<span class="w">                </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">){</span>
<span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">                                </span><span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="n">led_ld1</span><span class="p">.</span><span class="n">Pin</span><span class="p">);</span>
<span class="w">                                </span><span class="n">a</span><span class="o">=!</span><span class="n">a</span><span class="p">;</span>
<span class="w">                                </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">                                </span><span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="n">led_ld2</span><span class="p">.</span><span class="n">Pin</span><span class="p">);</span>
<span class="w">                        </span><span class="n">b</span><span class="o">=!</span><span class="n">b</span><span class="p">;</span>
<span class="w">                                </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="n">errors</span><span class="o">++</span><span class="p">;</span>
<span class="w">                                </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>


<span class="w">        </span><span class="p">}</span>
<span class="p">}</span>
</pre>
          </div>
         </div>
        </section>
        <section id="dependencias-de-software-del-ejemplo">
         <h2>
          Dependencias de software del ejemplo
          <a class="headerlink" href="#dependencias-de-software-del-ejemplo" title="Link to this heading">
           &para;
          </a>
         </h2>
         <ul class="simple">
          <li>
           <p>
            Librer&iacute;a HAL de STM32.
           </p>
          </li>
          <li>
           <p>
            CMSIS RTOS v2.
           </p>
          </li>
         </ul>
        </section>
        <section id="preguntas-y-respuestas-sobre-ejemplothreads-flags">
         <h2>
          Preguntas y respuestas sobre ejemplothreads-flags
          <a class="headerlink" href="#preguntas-y-respuestas-sobre-ejemplothreads-flags" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          Esta secci&oacute;n contiene una serie de preguntas con sus respectivas respuestas sobre el funcionamiento del c&oacute;digo que utiliza CMSIS RTOS v2 para controlar LEDs en una placa STM32.
         </p>
         <section id="se-modifica-el-codigo-del-producer-para-que-envie-ambas-senales-0x0001-y-0x0002-de-forma-casi-simultanea-seguido-de-un-delay-de-1-segundo">
          <h3>
           Se modifica el c&oacute;digo del Producer para que env&iacute;e ambas se&ntilde;ales (0x0001 y 0x0002) de forma casi simult&aacute;nea, seguido de un delay de 1 segundo:
           <a class="headerlink" href="#se-modifica-el-codigo-del-producer-para-que-envie-ambas-senales-0x0001-y-0x0002-de-forma-casi-simultanea-seguido-de-un-delay-de-1-segundo" title="Link to this heading">
            &para;
           </a>
          </h3>
          <div class="highlight-c notranslate">
           <div class="highlight">
            <pre><span></span><span class="linenos">1</span><span class="kt">void</span><span class="w"> </span><span class="nf">Producer</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">argument</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2</span><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="linenos">3</span><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">4</span><span class="w">                </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadFlagsSet</span><span class="p">(</span><span class="n">tid_Thread_consumer</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0001</span><span class="p">);</span>
<span class="linenos">5</span><span class="w">                </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadFlagsSet</span><span class="p">(</span><span class="n">tid_Thread_consumer</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0002</span><span class="p">);</span>
<span class="linenos">6</span><span class="w">                </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos">7</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">8</span><span class="p">}</span>
</pre>
           </div>
          </div>
          <p>
           Analice el comportamiento resultante del sistema y responda:
          </p>
          <ol class="arabic simple">
           <li>
            <p>
             &iquest;Qu&eacute; valor tendr&iacute;a la variable status en el Consumer despu&eacute;s de osThreadFlagsWait?
            </p>
           </li>
           <li>
            <p>
             &iquest;C&oacute;mo afecta esta modificaci&oacute;n al parpadeo de los LEDs?
            </p>
           </li>
          </ol>
          <ol class="arabic simple">
           <li>
            <p>
             Valor de status: La variable status en el Consumer tendr&iacute;a el valor 0x0003 (0x0001 | 0x0002), ya que los flags se acumulan en el sistema CMSIS-RTOS cuando se env&iacute;an antes de que el thread destino los procese.
            </p>
           </li>
           <li>
            <p>
             Efecto en los LEDs: Los LEDs dejar&iacute;an de parpadear por completo. El switch statement en el Consumer solo maneja expl&iacute;citamente los casos 1 (0x0001) y 2 (0x0002). Al recibir el valor combinado 3, la ejecuci&oacute;n cae en el caso default, donde solo se incrementa la variable errors sin ejecutar ninguna operaci&oacute;n de toggle en los GPIOs.
            </p>
           </li>
          </ol>
         </section>
        </section>
       </section>
       <span id="document-ejemplothreads-software-timers">
       </span>
       <section id="uso-basico-de-threads-y-software-timers-en-cmsis-rtos-v2">
        <h1>
         Uso b&aacute;sico de threads y software timers en CMSIS RTOS v2
         <a class="headerlink" href="#uso-basico-de-threads-y-software-timers-en-cmsis-rtos-v2" title="Link to this heading">
          &para;
         </a>
        </h1>
        <p>
         Esta secci&oacute;n describe el funcionamiento de un programa en C que utiliza CMSIS RTOS v2 y la biblioteca HAL de STM32 para controlar dos LEDs mediante un hilo y timers software.
        </p>
        <section id="descripcion-general">
         <h2>
          Descripci&oacute;n General
          <a class="headerlink" href="#descripcion-general" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          El programa crea un &uacute;nico hilo denominado
          <code class="docutils literal notranslate">
           <span class="pre">
            Timers
           </span>
          </code>
          . Este hilo se encarga de configurar los pines B0 y B7 como salida para excitar los LEDs LD1 y LD2. Ademas crea un timer one-shot y otro periodico.
El timer one-shot se inicia para que al cabo de 10 segundos se active y en su callback se encienda el led LD1 y se inicie el timer peri&oacute;dico. El timer peri&oacute;dico hace que el led LD2 parpadee cada 500ms.
         </p>
         <p>
          Se define una estructura llamada
          <code class="docutils literal notranslate">
           <span class="pre">
            mygpio_pin
           </span>
          </code>
          que encapsula toda la informaci&oacute;n necesaria para controlar un LED:
         </p>
         <ul class="simple">
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              GPIO_InitTypeDef
             </span>
             <span class="pre">
              pin
             </span>
            </code>
            : configuraci&oacute;n del pin (modo, velocidad, tipo de salida).
           </p>
          </li>
          <li>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              GPIO_TypeDef
             </span>
             <span class="pre">
              *port
             </span>
            </code>
            : puerto GPIO al que pertenece el pin.
           </p>
          </li>
         </ul>
         <p>
          La funci&oacute;n
          <code class="docutils literal notranslate">
           <span class="pre">
            Init_Thread
           </span>
          </code>
          realiza las siguientes operaciones:
         </p>
         <ol class="arabic simple">
          <li>
           <p>
            Crea un hilo
            <code class="docutils literal notranslate">
             <span class="pre">
              Timers
             </span>
            </code>
            con
            <code class="docutils literal notranslate">
             <span class="pre">
              osThreadNew
             </span>
            </code>
            .
           </p>
          </li>
         </ol>
        </section>
        <section id="funcion-del-hilo-timers">
         <h2>
          Funci&oacute;n del Hilo
          <code class="docutils literal notranslate">
           <span class="pre">
            Timers
           </span>
          </code>
          <a class="headerlink" href="#funcion-del-hilo-timers" title="Link to this heading">
           &para;
          </a>
         </h2>
         <dl class="simple">
          <dt>
           La funci&oacute;n
           <code class="docutils literal notranslate">
            <span class="pre">
             Timers(void
            </span>
            <span class="pre">
             *arg)
            </span>
           </code>
           realiza las siguientes operaciones:
          </dt>
          <dd>
           <ol class="arabic simple">
            <li>
             <p>
              Configura los pines GPIO para los LEDs LD1 y LD2.
             </p>
            </li>
            <li>
             <p>
              Ejecuta un bucle infinito que en cada iteraci&oacute;n expera 1 segundo.
             </p>
            </li>
           </ol>
          </dd>
         </dl>
        </section>
        <section id="uso-de-hal-y-cmsis-rtos">
         <h2>
          Uso de HAL y CMSIS RTOS
          <a class="headerlink" href="#uso-de-hal-y-cmsis-rtos" title="Link to this heading">
           &para;
          </a>
         </h2>
         <ul class="simple">
          <li>
           <p>
            <strong>
             HAL (Hardware Abstraction Layer)
            </strong>
            : se utiliza para configurar e inicializar los pines GPIO de forma sencilla y portable.
           </p>
          </li>
          <li>
           <p>
            <strong>
             CMSIS RTOS v2
            </strong>
            : proporciona las funciones para crear y gestionar hilos, como
            <code class="docutils literal notranslate">
             <span class="pre">
              osThreadNew
             </span>
            </code>
            y
            <code class="docutils literal notranslate">
             <span class="pre">
              osDelay
             </span>
            </code>
            , y funciones espec&iacute;ficas para gestionar timers.
           </p>
          </li>
         </ul>
        </section>
        <section id="codigo-especifico">
         <h2>
          C&oacute;digo espec&iacute;fico
          <a class="headerlink" href="#codigo-especifico" title="Link to this heading">
           &para;
          </a>
         </h2>
         <div class="highlight-c notranslate">
          <div class="highlight">
           <pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"cmsis_os2.h"</span><span class="c1">                          // CMSIS RTOS header file</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_hal.h"</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="kt">void</span><span class="w"> </span><span class="nf">Init_Threads</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="linenos"> 8</span><span class="kt">void</span><span class="w"> </span><span class="nf">Timers</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span>
<span class="linenos"> 9</span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">led_ld1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">10</span><span class="w">                </span><span class="p">.</span><span class="n">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_0</span><span class="p">,</span>
<span class="linenos">11</span><span class="w">                </span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">,</span>
<span class="linenos">12</span><span class="w">                </span><span class="p">.</span><span class="n">Pull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_NOPULL</span><span class="p">,</span>
<span class="linenos">13</span><span class="w">                </span><span class="p">.</span><span class="n">Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span>
<span class="linenos">14</span><span class="w">        </span><span class="p">};</span>
<span class="linenos">15</span><span class="w">        </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">led_ld2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">16</span><span class="w">                </span><span class="p">.</span><span class="n">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_7</span><span class="p">,</span>
<span class="linenos">17</span><span class="w">                </span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">,</span>
<span class="linenos">18</span><span class="w">                </span><span class="p">.</span><span class="n">Pull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_NOPULL</span><span class="p">,</span>
<span class="linenos">19</span><span class="w">                </span><span class="p">.</span><span class="n">Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span>
<span class="linenos">20</span><span class="w">        </span><span class="p">};</span>
<span class="linenos">21</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">24</span><span class="w">        </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">pin</span><span class="p">;</span>
<span class="linenos">25</span><span class="w">                </span><span class="n">GPIO_TypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">;</span>
<span class="linenos">26</span><span class="p">}</span><span class="w"> </span><span class="n">mygpio_pin</span><span class="p">;</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="n">mygpio_pin</span><span class="w"> </span><span class="n">pinB0</span><span class="p">;</span>
<span class="linenos">29</span><span class="n">mygpio_pin</span><span class="w"> </span><span class="n">pinB7</span><span class="p">;</span>
<span class="linenos">30</span><span class="kt">void</span><span class="w"> </span><span class="nf">Timer1_Callback_1</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="linenos">31</span><span class="kt">void</span><span class="w"> </span><span class="nf">Timer1_Callback_2</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="linenos">32</span><span class="n">osTimerId_t</span><span class="w"> </span><span class="n">timsoft2</span><span class="w"> </span><span class="p">;</span>
<span class="linenos">33</span><span class="kt">void</span><span class="w"> </span><span class="nf">Init_Threads</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
<span class="linenos">34</span><span class="w">        </span><span class="n">osThreadId_t</span><span class="w"> </span><span class="n">tid_Thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osThreadNew</span><span class="p">(</span><span class="n">Timers</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="linenos">35</span><span class="p">}</span>
<span class="linenos">36</span><span class="kt">void</span><span class="w"> </span><span class="nf">Timers</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">37</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">        </span><span class="n">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="p">();</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">        </span><span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">led_ld1</span><span class="p">);</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="w">        </span><span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">led_ld2</span><span class="p">);</span>
<span class="linenos">44</span><span class="w">        </span><span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="n">led_ld1</span><span class="p">.</span><span class="n">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PIN_RESET</span><span class="p">);</span>
<span class="linenos">45</span><span class="w">        </span><span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="n">led_ld2</span><span class="p">.</span><span class="n">Pin</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PIN_RESET</span><span class="p">);</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">        </span><span class="n">osTimerId_t</span><span class="w"> </span><span class="n">timsoft1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osTimerNew</span><span class="p">(</span><span class="n">Timer1_Callback_1</span><span class="p">,</span><span class="w"> </span><span class="n">osTimerOnce</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="linenos">48</span>
<span class="hll"><span class="linenos">49</span><span class="w">        </span><span class="n">osTimerStart</span><span class="p">(</span><span class="n">timsoft1</span><span class="p">,</span><span class="mi">10000</span><span class="p">);</span>
</span><span class="linenos">50</span><span class="w">        </span><span class="n">timsoft2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">osTimerNew</span><span class="p">(</span><span class="n">Timer1_Callback_2</span><span class="p">,</span><span class="w"> </span><span class="n">osTimerPeriodic</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="linenos">51</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
<span class="linenos">54</span><span class="w">                </span><span class="n">osDelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="linenos">55</span><span class="p">}</span>
<span class="linenos">56</span><span class="p">}</span>
<span class="linenos">57</span><span class="kt">void</span><span class="w"> </span><span class="nf">Timer1_Callback_1</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">){</span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="w">                        </span><span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="n">led_ld1</span><span class="p">.</span><span class="n">Pin</span><span class="p">);</span>
<span class="linenos">60</span><span class="w">                        </span><span class="n">osTimerStart</span><span class="p">(</span><span class="n">timsoft2</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">);</span>
<span class="linenos">61</span>
<span class="linenos">62</span><span class="p">}</span>
<span class="linenos">63</span>
<span class="linenos">64</span><span class="kt">void</span><span class="w"> </span><span class="nf">Timer1_Callback_2</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">){</span>
<span class="linenos">65</span>
<span class="linenos">66</span><span class="w">                        </span><span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="n">led_ld2</span><span class="p">.</span><span class="n">Pin</span><span class="p">);</span>
<span class="linenos">67</span>
<span class="linenos">68</span><span class="p">}</span>
</pre>
          </div>
         </div>
        </section>
        <section id="dependencia">
         <h2>
          Dependencia
          <a class="headerlink" href="#dependencia" title="Link to this heading">
           &para;
          </a>
         </h2>
         <ul class="simple">
          <li>
           <p>
            Librer&iacute;a HAL de STM32.
           </p>
          </li>
          <li>
           <p>
            CMSIS RTOS v2.
           </p>
          </li>
         </ul>
        </section>
        <section id="preguntas-y-respuestas-sobre-ejemplothreads-timers">
         <h2>
          Preguntas y respuestas sobre ejemplothreads-timers
          <a class="headerlink" href="#preguntas-y-respuestas-sobre-ejemplothreads-timers" title="Link to this heading">
           &para;
          </a>
         </h2>
         <p>
          Esta secci&oacute;n contiene una serie de preguntas con sus respectivas respuestas sobre el funcionamiento del c&oacute;digo que utiliza CMSIS RTOS v2 para controlar LEDs en una placa STM32.
         </p>
         <section id="cual-es-la-diferencia-fundamental-entre-un-timer-periodico-otro-one-shot">
          <h3>
           &iquest;Cual es la diferencia fundamental entre un timer peri&oacute;dico otro one-shot?
           <a class="headerlink" href="#cual-es-la-diferencia-fundamental-entre-un-timer-periodico-otro-one-shot" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           El timer one-shot dispara la funci&oacute;n de callback una sola vez. Es importante indicar que el tiempo empieza a contar desde que el timer es arrancado.
Un timer peri&oacute;dico por contra ejecuta la funci&oacute;n de callback multiples veces.
Es importante hacer notar que la funci&oacute;n de arrancar un timer no se puede llamar desde una rutina de atenci&oacute;n a la interrupci&oacute;n.
La funci&oacute;n de arrancar un timer se puede llamar de manera reiterada reiniciando la cuenta de tiempo del mismo.
          </p>
         </section>
         <section id="los-ficheros-rtx-config-h-y-rtx-config-c-son-generados-automaticamente-por-el-entorno-de-desarrollo-se-pueden-modificar">
          <h3>
           Los ficheros RTX_config.h y RTX_config.c son generados autom&aacute;ticamente por el entorno de desarrollo. &iquest;Se pueden modificar?
           <a class="headerlink" href="#los-ficheros-rtx-config-h-y-rtx-config-c-son-generados-automaticamente-por-el-entorno-de-desarrollo-se-pueden-modificar" title="Link to this heading">
            &para;
           </a>
          </h3>
          <p>
           S&iacute;, se pueden modificar. Estos ficheros contienen configuraciones espec&iacute;ficas del sistema operativo en tiempo real (RTOS) RTX, como el n&uacute;mero m&aacute;ximo de hilos, la prioridad de los hilos, el tama&ntilde;o de la pila, entre otros par&aacute;metros.
Modificar estos archivos permite ajustar el comportamiento del RTOS seg&uacute;n las necesidades espec&iacute;ficas de la aplicaci&oacute;n.
          </p>
         </section>
         <section id="si-se-fija-un-punto-de-ruptura-en-la-linea-47-que-se-espera-ver-en-el-watch-windows-rtx-rtos">
          <h3>
           Si se fija un punto de ruptura en la l&iacute;nea 47, &iquest;qu&eacute; se espera ver en el
           <code class="docutils literal notranslate">
            <span class="pre">
             Watch
            </span>
            <span class="pre">
             Windows-&gt;RTX
            </span>
            <span class="pre">
             RTOS
            </span>
           </code>
           ?
           <a class="headerlink" href="#si-se-fija-un-punto-de-ruptura-en-la-linea-47-que-se-espera-ver-en-el-watch-windows-rtx-rtos" title="Link to this heading">
            &para;
           </a>
          </h3>
          <ol class="arabic simple">
           <li>
            <p>
             El hilo en estado running. Adem&aacute;s no es el &uacute;nico hilo porque aparece el hilo
             <code class="docutils literal notranslate">
              <span class="pre">
               osRtxIdleThread
              </span>
             </code>
             y
             <code class="docutils literal notranslate">
              <span class="pre">
               osRtxTimerThread
              </span>
             </code>
             .
            </p>
           </li>
           <li>
            <p>
             Se visualiza una cola que es utiliza por el sistema operativo para gestionar eventos internos.
            </p>
           </li>
          </ol>
          <div class="admonition note">
           <p class="admonition-title">
            Note
           </p>
           <p>
            Challenge: Investigue el mecanismo para poder poner su propio c&oacute;digo en el thread
            <code class="docutils literal notranslate">
             <span class="pre">
              osRtxIdleThread
             </span>
            </code>
            .
           </p>
          </div>
          <div class="admonition warning">
           <p class="admonition-title">
            Warning
           </p>
           <p>
            No utilice las funciones de manejo de timers software desde rutinas de atenci&oacute;n a la interrupci&oacute;n.
           </p>
          </div>
         </section>
        </section>
       </section>
      </div>
      <div class="clearer">
      </div>
     </div>
    </div>
   </div>
   <div class="clearer">
   </div>
  </div>
  <article id="back-cover">
   <div class="container">
    <div class="back-cover-footer">
     <p>
      &copy; Copyright Universidad Polit&eacute;cnica de Madrid.
     </p>
     <p>
      Created using
      <a href="http://sphinx-doc.org/">
       Sphinx
      </a>
      8.2.3.
     </p>
    </div>
   </div>
  </article>
 </body>
</html>
